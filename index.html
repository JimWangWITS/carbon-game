<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#1e293b">
    
    <!-- SEO Meta Tags -->
    <title>ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ° - å›åˆåˆ¶ç¢³è²»ç­–ç•¥éŠæˆ²</title>
    <meta name="description" content="åœ¨æœªä¾†åŸå¸‚ä¸­ç¶“ç‡Ÿä¼æ¥­ï¼Œèˆ‡ NPC ç«¶çˆ­ç‰ˆåœ–ï¼Œç®¡ç†ç¢³è²»èˆ‡æ’æ”¾ï¼Œå°æŠ—æ’æ”¾æ€ªç¸ã€‚å›åˆåˆ¶ç­–ç•¥éŠæˆ²ï¼Œé«”é©—ç¢³è²»åˆ¶åº¦å¸¶ä¾†çš„ç¶“ç‡ŸæŒ‘æˆ°ã€‚">
    <meta name="keywords" content="ç¢³è²», ç­–ç•¥éŠæˆ², å›åˆåˆ¶éŠæˆ², ç’°ä¿éŠæˆ², ä¼æ¥­ç¶“ç‡Ÿ, ç¢³æ’æ”¾, ä½ç¢³, ç¶²é éŠæˆ²">
    <meta name="author" content="ä½ç¢³éœ¸ä¸»éŠæˆ²åœ˜éšŠ">
    <meta name="robots" content="index, follow">
    <meta name="language" content="zh-TW">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/">
    <meta property="og:title" content="ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ° - å›åˆåˆ¶ç¢³è²»ç­–ç•¥éŠæˆ²">
    <meta property="og:description" content="åœ¨æœªä¾†åŸå¸‚ä¸­ç¶“ç‡Ÿä¼æ¥­ï¼Œèˆ‡ NPC ç«¶çˆ­ç‰ˆåœ–ï¼Œç®¡ç†ç¢³è²»èˆ‡æ’æ”¾ï¼Œå°æŠ—æ’æ”¾æ€ªç¸ã€‚å›åˆåˆ¶ç­–ç•¥éŠæˆ²ï¼Œé«”é©—ç¢³è²»åˆ¶åº¦å¸¶ä¾†çš„ç¶“ç‡ŸæŒ‘æˆ°ã€‚">
    <meta property="og:image" content="https://your-domain.com/og-image.png">
    <meta property="og:locale" content="zh_TW">
    <meta property="og:site_name" content="ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ°">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://your-domain.com/">
    <meta name="twitter:title" content="ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ° - å›åˆåˆ¶ç¢³è²»ç­–ç•¥éŠæˆ²">
    <meta name="twitter:description" content="åœ¨æœªä¾†åŸå¸‚ä¸­ç¶“ç‡Ÿä¼æ¥­ï¼Œèˆ‡ NPC ç«¶çˆ­ç‰ˆåœ–ï¼Œç®¡ç†ç¢³è²»èˆ‡æ’æ”¾ï¼Œå°æŠ—æ’æ”¾æ€ªç¸ã€‚å›åˆåˆ¶ç­–ç•¥éŠæˆ²ï¼Œé«”é©—ç¢³è²»åˆ¶åº¦å¸¶ä¾†çš„ç¶“ç‡ŸæŒ‘æˆ°ã€‚">
    <meta name="twitter:image" content="https://your-domain.com/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="manifest" href="site.webmanifest">
    
    <!-- Google Analytics (å¯é¸) - å–æ¶ˆè¨»è§£ä¸¦æ›¿æ› YOUR_GA_ID ä»¥å•Ÿç”¨ -->
    <!--
    <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'YOUR_GA_ID');
    </script>
    -->
    
    <!-- é–‹ç™¼æ¨¡å¼é–‹é—œ (è¨­å®šç‚º false å¯é—œé–‰è©³ç´°æ—¥èªŒ) -->
    <script>
        window.DEBUG_MODE = false; // è¨­ç‚º true å¯å•Ÿç”¨è©³ç´°çš„ console æ—¥èªŒ
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            /* è¡Œå‹•è£ç½®å„ªåŒ– */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* å…è¨±æ–‡å­—é¸æ“‡çš„å€åŸŸ */
        .selectable, input, textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .font-cartoon {
            font-family: 'Fredoka', sans-serif;
        }

        /* å‹•ç•«å®šç¾© */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px) rotate(-5deg);
            }

            75% {
                transform: translateX(5px) rotate(5deg);
            }
        }

        @keyframes screen-shake {
            0%, 100% {
                transform: translateX(0) translateY(0);
            }
            10% {
                transform: translateX(-1px) translateY(-1px);
            }
            20% {
                transform: translateX(1px) translateY(1px);
            }
            30% {
                transform: translateX(-1px) translateY(1px);
            }
            40% {
                transform: translateX(1px) translateY(-1px);
            }
            50% {
                transform: translateX(-1px) translateY(0);
            }
            60% {
                transform: translateX(1px) translateY(0);
            }
            70% {
                transform: translateX(0) translateY(-1px);
            }
            80% {
                transform: translateX(0) translateY(1px);
            }
            90% {
                transform: translateX(0) translateY(0);
            }
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        .animate-breathe {
            animation: breathe 3s infinite;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* éŠæˆ²ç‰¹å®šæ¨£å¼ */
        .monster-shadow {
            transition: all 1s ease;
            filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.5));
        }

        /* æ»¾å‹•æ•¸å­—æ¨£å¼ */
        .counter {
            font-variant-numeric: tabular-nums;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* åœ°å¡Šå›ºå®šç‚ºæ­£æ–¹å½¢ */
        #game-grid>div {
            width: 6rem;
            height: 6rem;
        }

        /* ===== 3D åŸå¸‚è¦–è¦ºç³»çµ± ===== */
        
        /* ç­‰è·è¦–è§’å®¹å™¨ */
        .city-3d-container {
            perspective: 2000px;
            perspective-origin: 50% 40%;
            transform-style: preserve-3d;
        }

        /* åŸå¸‚ç¶²æ ¼ - åˆ†å€å¼è¨­è¨ˆ */
        #game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 6px;
            padding: 20px;
            width: fit-content;
            min-width: fit-content;
            max-width: 100vw;
            margin: 0 auto;
            position: relative;
            overflow: visible;
        }

        /* å€åŸŸåˆ†éš”ç·š */
        .zone-divider-vertical {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, transparent, rgba(100, 100, 100, 0.5), transparent);
            z-index: 1;
            pointer-events: none;
        }

        .zone-divider-horizontal {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, rgba(100, 100, 100, 0.5), transparent);
            z-index: 1;
            pointer-events: none;
        }

        /* å€åŸŸæ¨™ç±¤ */
        .zone-label {
            position: absolute;
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            color: #94a3b8;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            z-index: 2;
            pointer-events: none;
            white-space: nowrap;
        }

        /* å€åŸŸèƒŒæ™¯ï¼ˆè¼•å¾®ï¼‰ */
        .zone-bg {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            pointer-events: none;
            z-index: 0;
        }

        .zone-bg-player {
            background: rgba(59, 130, 246, 0.05);
            border: 1px dashed rgba(59, 130, 246, 0.2);
        }

        .zone-bg-npc-a {
            background: rgba(244, 63, 94, 0.05);
            border: 1px dashed rgba(244, 63, 94, 0.2);
        }

        .zone-bg-npc-b {
            background: rgba(14, 165, 233, 0.05);
            border: 1px dashed rgba(14, 165, 233, 0.2);
        }

        .zone-bg-npc-c {
            background: rgba(245, 158, 11, 0.05);
            border: 1px dashed rgba(245, 158, 11, 0.2);
        }

        /* åœ°å¡Š - ç°¡æ½”çš„ 2D è¨­è¨ˆ */
        .tile-3d-base {
            width: 96px;
            height: 96px;
            position: relative;
            transition: all 0.2s ease;
        }

        /* åœ°å¡Šé ‚é¢ - ç°¡æ½”è¨­è¨ˆ */
        .tile-top {
            position: absolute;
            width: 96px;
            height: 96px;
            background: #1a202c;
            border: 2px solid #374151;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }


        /* ç…™éœ§æ•ˆæœï¼ˆé«˜æ’æ”¾å»ºç¯‰ï¼‰ */
        .smoke-effect {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 40px;
            background: radial-gradient(circle, rgba(100,100,100,0.7), transparent);
            border-radius: 50%;
            animation: smoke-rise 3s infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes smoke-rise {
            0% {
                transform: translateX(-50%) translateY(0) scale(0.8);
                opacity: 0.8;
            }
            100% {
                transform: translateX(-50%) translateY(-50px) scale(1.8);
                opacity: 0;
            }
        }

        /* æ€ªç¸å‹•æ…‹æ¥è¿‘ç³»çµ± */
        .monster-approach-container {
            position: fixed;
            right: 0;
            bottom: 0;
            transform-style: preserve-3d;
            transition: all 2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5;
            pointer-events: none;
        }

        /* æ€ªç¸éšæ®µæ¨£å¼ */
        .monster-stage-1 {
            transform: translateX(600px) translateZ(-1500px) scale(0.2);
            opacity: 0.1;
        }

        .monster-stage-2 {
            transform: translateX(400px) translateZ(-800px) scale(0.4);
            opacity: 0.3;
        }

        .monster-stage-3 {
            transform: translateX(200px) translateZ(-300px) scale(0.7);
            opacity: 0.6;
        }

        .monster-stage-4 {
            transform: translateX(50px) translateZ(-100px) scale(1.1);
            opacity: 0.85;
        }

        .monster-stage-5 {
            transform: translateX(0px) translateZ(0px) scale(1.5);
            opacity: 1;
        }

        /* æ€ªç¸ 3D è¦–è¦º */
        .monster-3d {
            position: relative;
            width: 200px;
            height: 200px;
            transform-style: preserve-3d;
            animation: monster-breathe 2s ease-in-out infinite;
        }

        @keyframes monster-breathe {
            0%, 100% {
                transform: scale(1) translateY(0);
            }
            50% {
                transform: scale(1.1) translateY(-10px);
            }
        }

        .monster-body-3d {
            position: absolute;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #881337, #1f2937);
            border-radius: 50%;
            box-shadow: 
                0 0 30px rgba(220, 38, 38, 0.8),
                inset 0 0 20px rgba(0,0,0,0.5);
        }

        .monster-eye-3d {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            box-shadow: 0 0 15px #ff0000;
            animation: eye-glow 1s ease-in-out infinite;
        }

        @keyframes eye-glow {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 15px #ff0000;
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 0 25px #ff0000;
            }
        }

        /* å±å¹•é‚Šç·£è­¦å‘Šå…‰æ•ˆ */
        .monster-warning-edge {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(to left, rgba(220, 38, 38, 0), rgba(220, 38, 38, 0.6));
            pointer-events: none;
            z-index: 40;
            transition: width 1s ease-out;
        }

        .monster-warning-edge.active {
            width: 150px;
            animation: warning-pulse 2s ease-in-out infinite;
        }

        @keyframes warning-pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 0.9;
            }
        }

        /* åœ°å¡Šæ‡¸åœæ•ˆæœ - ç°¡æ½” */
        .tile-3d-base:hover {
            transform: scale(1.05);
        }

        .tile-3d-base:hover .tile-top {
            border-color: #3b82f6;
        }

        /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */
        
        /* æŠ½å±œå‹•ç•« */
        .drawer {
            transition: transform 0.3s ease-in-out;
        }

        /* æ‰‹æ©Ÿç«¯ï¼šæŠ½å±œé»˜èªéš±è— */
        @media (max-width: 768px) {
            .drawer-hidden {
                transform: translateX(-100%);
            }

            .drawer-right-hidden {
                transform: translateX(100%);
            }
        }

        /* æ¡Œé¢ç«¯ï¼šæŠ½å±œå§‹çµ‚é¡¯ç¤ºï¼ˆä¸ä½¿ç”¨ transformï¼‰ */
        @media (min-width: 768px) {
            .drawer-hidden,
            .drawer-right-hidden {
                transform: none;
            }
        }

        /* é®ç½©å±¤ */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        .drawer-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* æ‰‹æ©Ÿç«¯åœ°å¡Šç¸®å°ï¼Œä½†ä¿æŒ 5 åˆ—å¸ƒå±€ */
        @media (max-width: 768px) {
            .tile-3d-base {
                width: 50px;
                height: 50px;
            }

            .tile-top {
                width: 50px;
                height: 50px;
            }

            #game-grid {
                grid-template-columns: repeat(5, 1fr) !important;
                grid-template-rows: repeat(4, 1fr) !important;
                gap: 4px;
                padding: 10px;
                min-width: fit-content;
                max-width: 100vw;
                overflow: visible;
                margin: 0 !important; /* æ”¹ç‚ºå·¦å°é½Šï¼Œä¸è¦å±…ä¸­ */
            }

            /* ç¢ºä¿çˆ¶å®¹å™¨å¯ä»¥æ»¾å‹•ï¼Œä¸”ç¶²æ ¼å¾å·¦é‚Šé–‹å§‹ */
            main.city-3d-container {
                overflow-x: auto;
                overflow-y: auto;
                justify-content: flex-start !important; /* æ”¹ç‚ºå·¦å°é½Š */
                align-items: flex-start !important; /* æ”¹ç‚ºé ‚éƒ¨å°é½Š */
                padding-top: 1rem; /* æ·»åŠ ä¸€äº›é ‚éƒ¨é–“è· */
            }

            /* æ‰‹æ©Ÿç«¯éš±è—å€åŸŸæ¨™è¨˜ï¼ˆå› ç‚ºç©ºé–“è¼ƒå°ï¼‰ */
            .zone-label,
            .zone-divider-vertical,
            .zone-divider-horizontal,
            .zone-bg {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .tile-3d-base {
                width: 40px;
                height: 40px;
            }

            .tile-top {
                width: 40px;
                height: 40px;
            }

            #game-grid {
                grid-template-columns: repeat(5, 1fr) !important;
                grid-template-rows: repeat(4, 1fr) !important;
                gap: 3px;
                padding: 8px;
                min-width: fit-content;
                max-width: 100vw;
                overflow: visible;
                margin: 0 !important; /* æ”¹ç‚ºå·¦å°é½Š */
            }

            /* ç¢ºä¿çˆ¶å®¹å™¨å¯ä»¥æ»¾å‹• */
            main.city-3d-container {
                overflow-x: auto;
                overflow-y: auto;
                justify-content: flex-start !important;
                align-items: flex-start !important;
                padding-top: 0.5rem;
            }
        }

        /* ===== Loading ç•«é¢éŸ¿æ‡‰å¼æ¨£å¼ï¼ˆå„ªåŒ–æ–‡å­—æ¸…æ™°åº¦ï¼‰ ===== */
        #loading-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-content {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .loading-image-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .loading-image {
            width: 100%;
            max-width: 100vw;
            height: auto;
            object-fit: contain;
            /* ä¿æŒåœ–ç‰‡æ¸…æ™°åº¦ï¼Œç‰¹åˆ¥æ˜¯æ–‡å­— */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
            /* å¹³æ»‘ç¸®æ”¾ */
            image-rendering: auto;
            /* ç¢ºä¿åœ–ç‰‡ä¸æœƒè¶…å‡ºè¦–çª— */
            max-height: 100vh;
            /* é˜²æ­¢åœ–ç‰‡æ¨¡ç³Š */
            -webkit-backface-visibility: hidden;
            -moz-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        /* æ ¹æ“šæ–¹å‘é¡¯ç¤ºå°æ‡‰çš„åœ–ç‰‡ */
        .loading-image-portrait {
            display: block;
        }

        .loading-image-landscape {
            display: none;
        }

        @media (orientation: landscape) {
            .loading-image-portrait {
                display: none;
            }

            .loading-image-landscape {
                display: block;
            }
        }

        .loading-dots {
            margin-top: 1.5rem;
        }

        .loading-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: rgb(34, 211, 238);
            border-radius: 50%;
            animation: pulse-glow 1.4s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 8px rgba(34, 211, 238, 0.8);
            }
            50% {
                opacity: 0.5;
                transform: scale(0.8);
                box-shadow: 0 0 4px rgba(34, 211, 238, 0.4);
            }
        }

        /* ç›´å¼æ‰‹æ©Ÿå„ªåŒ–ï¼ˆç›´å¼å°ˆç”¨åœ–ç‰‡å®Œæ•´é¡¯ç¤ºï¼‰ */
        @media (max-width: 768px) and (orientation: portrait) {
            .loading-content {
                padding: 1vh 0.5rem;
                justify-content: center;
            }

            .loading-image-container {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                min-height: 0;
                height: auto;
                max-height: calc(100vh - 8vh); /* ä¿ç•™ç©ºé–“çµ¦è¼‰å…¥å‹•ç•« */
            }

            .loading-image {
                /* ç›´å¼åœ–ç‰‡ï¼šä»¥å¯¬åº¦ç‚ºæº–ï¼Œå®Œæ•´é¡¯ç¤º */
                width: 100%;
                height: auto;
                max-width: 100vw;
                max-height: calc(100vh - 8vh);
                object-fit: contain;
                image-rendering: -webkit-optimize-contrast;
            }

            .loading-dots {
                margin-top: 1vh;
                margin-bottom: 0;
                flex-shrink: 0;
            }
        }

        /* æ‰‹æ©Ÿç«¯å„ªåŒ–ï¼ˆæ©«å‘æ¨¡å¼ - æ©«å‘å°ˆç”¨åœ–ç‰‡ï¼‰ */
        @media (max-width: 768px) and (orientation: landscape) {
            .loading-content {
                padding: 0.25rem;
                justify-content: center;
            }

            .loading-image-container {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                min-height: 0;
                /* æœ€å¤§åŒ–é«˜åº¦ï¼Œå¡«æ»¿ç•«é¢ */
                height: calc(100vh - 2vh);
            }

            .loading-image {
                /* æ©«å‘åœ–ç‰‡ï¼šä»¥é«˜åº¦ç‚ºæº–ï¼Œæœ€å¤§åŒ–å¡«æ»¿ */
                width: auto;
                height: 100%;
                max-width: 100vw;
                max-height: 100%;
                object-fit: contain;
                image-rendering: -webkit-optimize-contrast;
            }

            .loading-dots {
                margin-top: 0.25vh;
                margin-bottom: 0;
                flex-shrink: 0;
            }
        }

        /* å°è¢å¹•ç›´å¼æ‰‹æ©Ÿï¼ˆå°æ–¼ 480pxï¼‰ */
        @media (max-width: 480px) and (orientation: portrait) {
            .loading-content {
                padding: 0.75vh 0.25rem;
            }

            .loading-image-container {
                flex: 1;
                min-height: 0;
                height: auto;
                max-height: calc(100vh - 6vh);
            }

            .loading-image {
                /* å°è¢å¹•ç›´å¼ï¼šä»¥å¯¬åº¦ç‚ºæº–ï¼Œå®Œæ•´é¡¯ç¤º */
                width: 100%;
                height: auto;
                max-width: 100vw;
                max-height: calc(100vh - 6vh);
                object-fit: contain;
            }

            .loading-dots {
                margin-top: 0.75vh;
                margin-bottom: 0;
                flex-shrink: 0;
            }
        }

        /* å°è¢å¹•æ©«å‘æ¨¡å¼ */
        @media (max-width: 480px) and (orientation: landscape) {
            .loading-content {
                padding: 0.15rem;
            }

            .loading-image-container {
                height: calc(100vh - 1.5vh);
            }

            .loading-image {
                height: 100%;
                max-height: 100%;
                max-width: 100vw;
            }

            .loading-dots {
                margin-top: 0.15vh;
            }
        }

        /* æ¡Œé¢ç«¯æ©«å‘æ¨¡å¼å„ªåŒ– */
        @media (min-width: 769px) and (orientation: landscape) {
            .loading-content {
                padding: 0.5rem;
                justify-content: center;
            }

            .loading-image-container {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                min-height: 0;
                /* æœ€å¤§åŒ–é«˜åº¦ï¼Œå¡«æ»¿ç•«é¢ */
                height: calc(100vh - 2vh);
            }

            .loading-image {
                width: auto;
                height: 100%;
                max-width: 100vw;
                max-height: 100%;
                object-fit: contain;
            }

            .loading-dots {
                margin-top: 0.5vh;
            }
        }

        /* ä½é«˜åº¦æ©«å‘æ¨¡å¼ï¼ˆå¹³æ¿æ©«å‘ç­‰ï¼‰ */
        @media (max-height: 600px) and (orientation: landscape) {
            .loading-content {
                padding: 0.25rem;
            }

            .loading-image-container {
                height: calc(100vh - 1vh);
            }

            .loading-image {
                height: 100%;
                max-height: 100%;
                max-width: 100vw;
            }

            .loading-dots {
                margin-top: 0.25vh;
            }
        }

        /* é«˜è§£æåº¦è¢å¹•å„ªåŒ–ï¼ˆRetina ç­‰ï¼‰ */
        @media (-webkit-min-device-pixel-ratio: 2), 
               (min-resolution: 192dpi) {
            .loading-image {
                /* é«˜è§£æåº¦è¢å¹•ä¸Šä¿æŒæ¸…æ™° */
                image-rendering: -webkit-optimize-contrast;
            }
        }

        /* æ¡Œé¢ç«¯ç›´å¼æ¨¡å¼ï¼ˆæ¡Œé¢æ—‹è½‰è¢å¹•ç­‰ï¼‰ */
        @media (min-width: 769px) and (orientation: portrait) {
            .loading-content {
                padding: 2rem;
            }

            .loading-image-container {
                max-height: 90vh;
            }

            .loading-image {
                max-width: 100vw;
                max-height: 90vh;
                object-fit: contain;
            }
        }

        /* è¶…å¯¬è¢å¹•å„ªåŒ–ï¼ˆæ©«å‘ï¼‰ */
        @media (min-width: 1920px) and (orientation: landscape) {
            .loading-image {
                max-width: 1400px;
                max-height: 90vh;
            }
        }

        /* è¶…å¤§è¢å¹•ï¼ˆ4K æ©«å‘ï¼‰ */
        @media (min-width: 2560px) and (orientation: landscape) {
            .loading-image {
                max-width: 1800px;
                max-height: 90vh;
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden flex flex-col select-none">

    <!-- Loading ç•«é¢ -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center">
        <div class="loading-content text-center px-4 w-full max-w-5xl mx-auto">
            <div class="loading-image-container">
                <img src="images/loadingPortrait.png" 
                     alt="ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ°" 
                     class="loading-image loading-image-portrait mx-auto"
                     loading="eager">
                <img src="images/loadingVertical.png" 
                     alt="ä½ç¢³éœ¸ä¸»ï¼šæ€ªç¸ä¿è¡›æˆ°" 
                     class="loading-image loading-image-landscape mx-auto"
                     loading="eager">
            </div>
            <!-- è¼‰å…¥å‹•ç•«æŒ‡ç¤ºå™¨ -->
            <div class="loading-dots flex justify-center items-center gap-2">
                <div class="loading-dot"></div>
                <div class="loading-dot" style="animation-delay: 0.2s;"></div>
                <div class="loading-dot" style="animation-delay: 0.4s;"></div>
            </div>
        </div>
    </div>

    <!-- GAME HEADER -->
    <header
        class="h-16 md:h-16 sm:h-auto bg-slate-800 border-b-4 border-slate-700 flex flex-col md:flex-row items-center justify-between px-3 md:px-6 py-2 md:py-0 shrink-0 z-30 shadow-lg">
        <!-- å·¦å´ï¼šå¹´ä»½èˆ‡å›åˆ + æ‰‹æ©Ÿç«¯é¸å–®æŒ‰éˆ• -->
        <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto justify-between md:justify-start">
            <!-- æ‰‹æ©Ÿç«¯ï¼šæŠ½å±œæŒ‰éˆ• -->
            <button onclick="toggleLeftDrawer()" class="md:hidden px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg border border-slate-600 transition" title="é–‹å•Ÿç‹€æ…‹é¢æ¿">
                ğŸ“Š
            </button>
            
            <div class="flex items-center gap-2 md:gap-4">
                <div
                    class="bg-blue-600 text-white px-2 md:px-3 py-1 rounded-lg font-bold shadow-blue-500/50 shadow-lg transform -skew-x-12 border-2 border-blue-400">
                    <span class="not-italic text-sm md:text-lg" id="header-year">2030 å¹´</span>
            </div>
                <div class="text-slate-400 text-xs md:text-sm font-bold bg-slate-900 px-2 md:px-3 py-1 rounded-full border border-slate-600"
                id="header-turn">
                ç¬¬ 1 / 10 å›åˆ
            </div>
                <!-- æ¡Œé¢ç«¯ï¼šåŠŸèƒ½æŒ‰éˆ• -->
                <div class="hidden md:flex items-center gap-2">
                    <button onclick="openSaveLoadModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg border border-slate-600 transition" title="ä¿å­˜/è¼‰å…¥éŠæˆ²">
                        ğŸ’¾
                    </button>
                    <button onclick="openAchievementModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg border border-slate-600 transition relative" title="æˆå°±">
                        ğŸ†
                        <span id="achievement-badge" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center hidden"></span>
                    </button>
                    <button onclick="toggleDataPanel()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg border border-slate-600 transition" title="æ•¸æ“šé¢æ¿">
                        ğŸ“Š
                    </button>
                </div>
        </div>

            <!-- æ‰‹æ©Ÿç«¯ï¼šå³å´æŠ½å±œæŒ‰éˆ• -->
            <button onclick="toggleRightDrawer()" class="md:hidden px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg border border-slate-600 transition" title="é–‹å•Ÿå°æ‰‹é¢æ¿">
                ğŸ‘¥
            </button>
            </div>

        <!-- ä¸­é–“ï¼šæ€ªç¸æ€’æ°£å€¼ (æ±¡æŸ“åº¦) - æ¡Œé¢ç«¯å®Œæ•´ç‰ˆ -->
        <div class="hidden md:flex flex-col items-center flex-1 mx-2 relative" style="min-width: 500px; max-width: 800px;">
            <div class="flex items-center gap-2 mb-1 w-full justify-center relative group cursor-help">
                <span class="text-xs font-bold text-rose-400 animate-pulse uppercase tracking-wider whitespace-nowrap">âš ï¸ æ€ªç¸æ€’æ°£å€¼ (æ±¡æŸ“åº¦)</span>
                <!-- Tooltip - åªåœ¨æ¨™é¡Œä¸Šé¡¯ç¤º -->
                <div
                    class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-black/90 text-xs p-2 rounded text-slate-300 opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 w-64 text-center border border-slate-600 shadow-xl">
                    ç•¶æ€’æ°£å€¼æ»¿ 100%ï¼Œæ€ªç¸æœƒè¡é€²åŸå¸‚ï¼ŒéŠæˆ²ç›´æ¥çµæŸï¼<br>
                    <span class="text-yellow-400">70% æ™‚æ€ªç¸æœƒç‹‚æš´ (æ±¡æŸ“åŠ å€)</span>
                </div>
            </div>
            <!-- é€²åº¦æ¢å®¹å™¨ -->
            <div class="w-full relative">
                <!-- åˆ»åº¦æ¨™ç±¤ï¼ˆåœ¨é€²åº¦æ¢ä¸Šæ–¹ï¼‰ -->
                <div class="relative w-full mb-1" style="height: 16px;">
                    <div class="absolute left-[70%] transform -translate-x-1/2 text-[10px] text-yellow-400 font-bold whitespace-nowrap">
                        70% è­¦å‘Š
                    </div>
                    <div class="absolute left-[90%] transform -translate-x-1/2 text-[10px] text-red-400 font-bold whitespace-nowrap">
                        90% å±éšª
                    </div>
                </div>
                <!-- é€²åº¦æ¢èƒŒæ™¯ -->
                <div
                    class="w-full h-6 bg-slate-900 rounded-full border-2 border-slate-600 relative overflow-visible shadow-inner">
                    <!-- å±éšªåˆ»åº¦ç·š -->
                    <div class="absolute left-[70%] top-0 bottom-0 w-0.5 bg-yellow-500 z-10 opacity-70"></div>
                    <div class="absolute left-[90%] top-0 bottom-0 w-0.5 bg-red-600 z-10 opacity-70"></div>

                <!-- é€²åº¦æ¢ -->
                <div id="monster-bar"
                        class="h-full bg-gradient-to-r from-emerald-500 via-yellow-400 to-rose-600 transition-all duration-1000 ease-out relative rounded-full"
                    style="width: 20%">
                    <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/50 animate-pulse"></div>
                    <!-- ç²’å­æ•ˆæœ (CSS æ¨¡æ“¬) -->
                    <div
                            class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNCIgaGVpZ2h0PSI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxjaXJjbGUgY3g9IjIiIGN5PSIyIiByPSIxIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLz48L3N2Zz4=')] opacity-30 rounded-full">
                    </div>
                </div>
            </div>
            </div>
            <!-- æ¸›ç¢³æŠ•è³‡æŒ‰éˆ• -->
            <button id="carbon-investment-btn" onclick="investInCarbonReduction()"
                class="mt-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed relative z-10"
                title="æŠ•è³‡æ¸›ç¢³æŠ€è¡“ï¼Œé™ä½æ€ªç¸æ€’æ°£å€¼">
                ğŸŒ± æ¸›ç¢³æŠ•è³‡ ($15,000)
            </button>
        </div>

        <!-- æ‰‹æ©Ÿç«¯ï¼šæ€ªç¸æ€’æ°£å€¼ç°¡åŒ–ç‰ˆ -->
        <div class="md:hidden w-full px-2 mt-2">
            <div class="flex items-center justify-between mb-1">
                <span class="text-[10px] font-bold text-rose-400">âš ï¸ æ€ªç¸æ€’æ°£</span>
                <span id="monster-anger-mobile" class="text-xs font-bold text-rose-400">20%</span>
            </div>
            <div class="w-full h-4 bg-slate-900 rounded-full border border-slate-600 relative overflow-hidden">
                <div id="monster-bar-mobile"
                    class="h-full bg-gradient-to-r from-emerald-500 via-yellow-400 to-rose-600 transition-all duration-1000 ease-out rounded-full"
                    style="width: 20%">
                </div>
            </div>
            <button id="carbon-investment-btn-mobile" onclick="investInCarbonReduction()"
                class="mt-1 w-full px-2 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
                ğŸŒ± æ¸›ç¢³ ($15k)
            </button>
        </div>

        <!-- å³å´ï¼šç¢³åƒ¹è¡Œæƒ… - æ¡Œé¢ç«¯ -->
        <div class="hidden md:flex gap-4">
            <div class="bg-slate-900 px-4 py-1.5 rounded-lg border border-slate-600 flex flex-col items-end">
                <span class="text-[10px] text-slate-400">åœ‹å…§ç¢³è²»</span>
                <span class="font-mono font-bold text-emerald-400">$<span id="domestic-price">300</span></span>
            </div>
            <div class="bg-slate-900 px-4 py-1.5 rounded-lg border border-slate-600 flex flex-col items-end">
                <span class="text-[10px] text-slate-400">åœ‹éš›ç¢³æ¬Š</span>
                <span class="font-mono font-bold text-blue-400">$<span id="intl-price">800</span></span>
            </div>
        </div>
    </header>

    <!-- æŠ½å±œé®ç½©å±¤ -->
    <div id="drawer-overlay" class="drawer-overlay" onclick="closeAllDrawers()"></div>

    <div class="flex-1 flex overflow-hidden relative">

        <!-- å·¦å´é¢æ¿ï¼šç©å®¶ç‹€æ…‹ - éŸ¿æ‡‰å¼æŠ½å±œ -->
        <aside id="left-drawer" class="w-72 md:w-72 sm:w-80 bg-slate-800 border-r border-slate-700 flex flex-col z-50 md:z-20 shadow-2xl fixed md:relative inset-y-0 left-0 drawer drawer-hidden">
            <!-- ç©å®¶é ­åƒå€ -->
            <div class="p-6 bg-gradient-to-b from-slate-800 to-slate-900 border-b border-slate-700 text-center relative">
                <!-- æ‰‹æ©Ÿç«¯ï¼šé—œé–‰æŒ‰éˆ• -->
                <button onclick="closeAllDrawers()" class="md:hidden absolute top-2 right-2 text-slate-400 hover:text-white text-xl">âœ•</button>
                <div
                    id="player-avatar-container"
                    onclick="openAvatarModal()"
                    class="w-20 h-20 mx-auto bg-indigo-500 rounded-full border-4 border-slate-600 shadow-lg mb-3 overflow-hidden relative group cursor-pointer">
                    <img id="player-avatar-img"
                        src="https://api.dicebear.com/7.x/avataaars/svg?seed=Player1&backgroundColor=b6e3f4"
                        alt="Player Avatar" class="w-full h-full object-cover">
                    <div
                        class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-xs font-bold">
                        æ›´æ›</div>
                </div>
                <h2 class="text-xl font-bold text-white font-cartoon tracking-wide">æœªä¾† CEO</h2>
                <div
                    class="inline-block bg-indigo-900 text-indigo-200 text-xs px-2 py-0.5 rounded mt-1 border border-indigo-700">
                    ç­‰ç´š 1 æ–°æ‰‹è€é—†</div>
            </div>

            <!-- è³‡é‡‘èˆ‡è³‡æº -->
            <div class="p-4 space-y-6 flex-1 overflow-y-auto">
                <!-- éŒ¢åŒ… -->
                <div class="bg-slate-900/50 p-4 rounded-xl border-l-4 border-yellow-500 shadow-md">
                    <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">å…¬å¸è³‡é‡‘ (Capital)</div>
                    <div class="text-3xl font-mono font-bold text-yellow-400 text-shadow-sm animate-pulse-on-change"
                        id="player-money">$ 50,000</div>
                </div>

                <!-- æ’æ”¾è¨ˆé‡è¡¨ -->
                <div
                    class="bg-slate-900/50 p-4 rounded-xl border-l-4 border-rose-500 shadow-md relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">é ä¼°æ’æ”¾é‡</div>
                        <span
                            class="bg-rose-900/50 text-rose-300 text-[10px] px-2 py-0.5 rounded border border-rose-800"
                            id="emission-status">å®‰å…¨</span>
                    </div>
                    <div class="flex items-end gap-1">
                        <span class="text-2xl font-mono font-bold text-white" id="current-emission">8,000</span>
                        <span class="text-xs text-slate-500 mb-1">å™¸/å¹´</span>
                    </div>

                    <!-- ç´…ç¶ ç‡ˆè¦–è¦ºåŒ– -->
                    <div class="mt-3 flex gap-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                        <div class="flex-1 bg-emerald-500 opacity-100" title="å…ç¨…å€"></div>
                        <div class="flex-1 bg-yellow-500 opacity-30" title="æ”¶è²»å€"></div>
                        <div class="flex-1 bg-red-600 opacity-30" title="å±éšªå€"></div>
                    </div>
                    <div class="mt-1 flex justify-between text-[10px] text-slate-500 font-mono" id="emission-scale">
                        <span>0</span>
                        <span id="free-emission-display">10k (å…ç¨…é¡)</span>
                        <span id="red-zone-display">25k</span>
                    </div>
                </div>

                <!-- ç¢³æ¬ŠèƒŒåŒ… -->
                <div class="space-y-2">
                    <h3 class="text-xs text-slate-400 font-bold ml-1">ğŸ“¦ å€‰åº«å­˜è²¨</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex flex-col items-center">
                            <span class="text-2xl mb-1">ğŸ«</span>
                            <span class="text-[10px] text-slate-400">åœ‹å…§è¨±å¯è­‰</span>
                            <span class="font-bold text-emerald-400" id="local-credits">0</span>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex flex-col items-center">
                            <span class="text-2xl mb-1">ğŸŒ</span>
                            <span class="text-[10px] text-slate-400">åœ‹éš›ç¢³æ¬Š</span>
                            <span class="font-bold text-blue-400" id="intl-credits">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ©Ÿå™¨äººåŠ©æ‰‹ -->
            <div class="p-4 bg-slate-900 border-t border-slate-700 flex items-start gap-3 relative">
                <div
                    class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shrink-0 border-2 border-white shadow-lg animate-float z-10">
                    ğŸ¤–
                </div>
                <div
                    class="bg-white text-slate-800 p-3 rounded-lg rounded-tl-none text-xs shadow-lg relative bubble-triangle">
                    <p id="robot-msg">å—¨ï¼è€é—†ï¼æˆ‘æ˜¯è‰¾ä¾ã€‚<br>ç¾åœ¨æˆ‘å€‘åœ¨å®‰å…¨å€ï¼Œä¸éœ€è¦ä»˜ç¢³è²»å–”ï¼è“‹å·¥å» è¦å°å¿ƒæ€ªç¸ç”Ÿæ°£ï¼</p>
                </div>
            </div>
        </aside>

        <!-- ä¸»åœ°åœ–å€ -->
        <main
            class="flex-1 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 relative overflow-auto flex items-center justify-center city-3d-container">
            
            <!-- å¤©ç©ºèƒŒæ™¯ï¼ˆæ ¹æ“šæ€ªç¸æ€’æ°£å€¼è®Šè‰²ï¼‰ -->
            <div id="sky-background" class="absolute inset-0 transition-all duration-2000 pointer-events-none z-0">
                <div class="absolute inset-0 bg-gradient-to-b from-blue-900/20 via-slate-900 to-slate-800"></div>
                    </div>

            <!-- å±å¹•é‚Šç·£è­¦å‘Šå…‰æ•ˆ -->
            <div id="monster-warning-edge" class="monster-warning-edge"></div>

            <!-- æ€ªç¸å‹•æ…‹æ¥è¿‘ç³»çµ± -->
            <div id="monster-approach-container" class="monster-approach-container monster-stage-1">
                <div class="monster-3d">
                    <div class="monster-body-3d" id="monster-body-3d">
                        <!-- æ€ªç¸çœ¼ç› -->
                        <div class="monster-eye-3d" style="top: 40px; left: 40px;"></div>
                        <div class="monster-eye-3d" style="top: 50px; right: 40px;"></div>
                        <!-- æ€ªç¸å˜´å·´ -->
                        <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 60px; height: 30px; border: 3px solid #1f2937; border-top: none; border-radius: 0 0 30px 30px;"></div>
                    </div>
                    <!-- æ€ªç¸å…‰æ•ˆ -->
                    <div id="monster-glow-3d" class="absolute inset-0 bg-red-600 rounded-full blur-[100px] opacity-30" style="width: 200px; height: 200px; top: -25px; left: -25px;"></div>
                </div>
            </div>

            <!-- åŸå¸‚ç¶²æ ¼ï¼š3D ç­‰è·è¦–è§’ -->
            <div id="game-grid" class="relative z-10">
                <!-- ç”± JS å‹•æ…‹ç”Ÿæˆåœ°å¡Š -->
            </div>

            <!-- è£é£¾æ€§èƒŒæ™¯ç¶²æ ¼ -->
            <div
                class="absolute inset-0 pointer-events-none bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px] [mask-image:radial-gradient(ellipse_at_center,black_40%,transparent_100%)]">
            </div>
        </main>

        <!-- å³å´é¢æ¿ï¼šç«¶çˆ­å°æ‰‹èˆ‡æ–°è - éŸ¿æ‡‰å¼æŠ½å±œ -->
        <aside id="right-drawer" class="w-64 md:w-64 sm:w-80 bg-slate-800 border-l border-slate-700 flex flex-col z-50 md:z-20 shadow-2xl fixed md:relative inset-y-0 right-0 drawer drawer-right-hidden">
            <div class="p-4 bg-slate-900/80 border-b border-slate-700 flex items-center justify-between">
                <div>
                <h3 class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">COMPETITORS</h3>
                <p class="text-[10px] text-slate-400">ä½ çš„ç«¶çˆ­å°æ‰‹ç‹€æ³</p>
                </div>
                <!-- æ‰‹æ©Ÿç«¯ï¼šé—œé–‰æŒ‰éˆ• -->
                <button onclick="closeAllDrawers()" class="md:hidden text-slate-400 hover:text-white text-xl">âœ•</button>
            </div>

            <div class="p-3 space-y-3 overflow-y-auto flex-1">
                <!-- NPC A: æ¿€é€²æ´¾ -->
                <div
                    class="bg-slate-700 rounded-lg p-3 border-2 border-rose-500/40 hover:border-rose-400 transition group relative">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <div
                                class="w-8 h-8 rounded bg-rose-500 flex items-center justify-center text-lg shadow-lg border-2 border-white">
                                ğŸ˜¡</div>
                            <div>
                                <div class="text-sm font-bold text-white">æš´ç™¼æˆ¶é˜¿é‡‘</div>
                                <div class="text-[10px] text-rose-300" id="npcA-emission-label">é«˜æ’æ”¾å±éšªç¾¤</div>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-emerald-400" id="npcA-rank">#1</span>
                    </div>
                    <!-- è³‡é‡‘å’Œç¢³æ’æ”¾è³‡è¨Š -->
                    <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">è³‡é‡‘</div>
                            <div class="font-mono font-bold text-yellow-400" id="npcA-money">$50,000</div>
                        </div>
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">ç¢³æ’æ”¾</div>
                            <div class="font-mono font-bold text-rose-400" id="npcA-emission">0 å™¸</div>
                        </div>
                    </div>
                    <div class="h-1.5 bg-slate-900 rounded-full overflow-hidden">
                        <div class="w-[80%] h-full bg-rose-500" id="npcA-bar"></div>
                    </div>
                    <!-- æ°£æ³¡å°è©± -->
                    <div
                        class="absolute -left-32 top-0 bg-white text-black text-[10px] p-2 rounded rounded-r-none shadow-lg opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 w-28">
                        "ç¢³è²»ç®—ä»€éº¼ï¼Ÿæˆ‘æœ‰çš„æ˜¯éŒ¢ï¼å…¨éƒ¨è“‹ç‡ƒç…¤å» ï¼"
                    </div>
                </div>

                <!-- NPC B: æŠ€è¡“æ´¾ -->
                <div
                    class="bg-slate-700 rounded-lg p-3 border-2 border-sky-500/30 hover:border-sky-400 transition group relative">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <div
                                class="w-8 h-8 rounded bg-sky-500 flex items-center justify-center text-lg shadow-lg border-2 border-white">
                                ğŸ¤“</div>
                            <div>
                                <div class="text-sm font-bold text-white">åšå£«</div>
                                <div class="text-[10px] text-sky-300" id="npcB-emission-label">ç§‘æŠ€æ¸›ç¢³ä¸­...</div>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-slate-400" id="npcB-rank">#3</span>
                    </div>
                    <!-- è³‡é‡‘å’Œç¢³æ’æ”¾è³‡è¨Š -->
                    <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">è³‡é‡‘</div>
                            <div class="font-mono font-bold text-yellow-400" id="npcB-money">$45,000</div>
                        </div>
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">ç¢³æ’æ”¾</div>
                            <div class="font-mono font-bold text-rose-400" id="npcB-emission">0 å™¸</div>
                        </div>
                    </div>
                    <div class="h-1.5 bg-slate-900 rounded-full overflow-hidden">
                        <div class="w-[30%] h-full bg-sky-500" id="npcB-bar"></div>
                    </div>
                    <div
                        class="absolute -left-32 top-0 bg-white text-black text-[10px] p-2 rounded rounded-r-none shadow-lg opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 w-28">
                        "æ ¹æ“šè¨ˆç®—ï¼Œå‡ç´šç¶ èƒ½æ‰æ˜¯æœ€ä½³è§£..."
                    </div>
                </div>

                <!-- NPC C: æˆæœ¬æ´¾ -->
                <div
                    class="bg-slate-700 rounded-lg p-3 border-2 border-amber-500/30 hover:border-amber-400 transition group relative">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex gap-2">
                            <div
                                class="w-8 h-8 rounded bg-amber-500 flex items-center justify-center text-lg shadow-lg border-2 border-white">
                                ğŸ˜</div>
                            <div>
                                <div class="text-sm font-bold text-white">æˆæœ¬é­”äººå°æ</div>
                                <div class="text-[10px] text-amber-200" id="npcC-emission-label">ç²¾æ‰“ç´°ç®—å‹</div>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-slate-400" id="npcC-rank">#2</span>
                    </div>
                    <!-- è³‡é‡‘å’Œç¢³æ’æ”¾è³‡è¨Š -->
                    <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">è³‡é‡‘</div>
                            <div class="font-mono font-bold text-yellow-400" id="npcC-money">$47,000</div>
                        </div>
                        <div class="bg-slate-800/50 px-2 py-1 rounded">
                            <div class="text-slate-400">ç¢³æ’æ”¾</div>
                            <div class="font-mono font-bold text-rose-400" id="npcC-emission">0 å™¸</div>
                        </div>
                    </div>
                    <div class="h-1.5 bg-slate-900 rounded-full overflow-hidden">
                        <div class="w-[50%] h-full bg-amber-400" id="npcC-bar"></div>
                    </div>
                    <div
                        class="absolute -left-32 top-0 bg-white text-black text-[10px] p-2 rounded rounded-r-none shadow-lg opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 w-28">
                        "è³ºéŒ¢å¯ä»¥ï¼Œä½†ç¢³è²»è¦å£“åˆ°æœ€ä½ã€‚"
                    </div>
                </div>
            </div>

            <!-- æ–°èå¿«è¨Š -->
            <div class="h-1/3 border-t border-slate-700 bg-slate-900 p-4">
                <h3 class="text-xs text-blue-400 font-bold mb-2 flex items-center gap-1">
                    <span class="animate-pulse">ğŸ”´</span> æ–°èå¿«å ± (News)
                </h3>
                <div class="text-[11px] text-slate-300 space-y-2 font-mono" id="news-feed">
                    <p class="border-l-2 border-blue-500 pl-2">éŠæˆ²é–‹å§‹ï¼š2030 å¹´ï¼Œå››å®¶ä¼æ¥­æº–å‚™é–‹æˆ°ï¼</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- FOOTER: è¡Œå‹•å€ - éŸ¿æ‡‰å¼ -->
    <footer class="h-20 md:h-20 sm:h-auto sm:py-2 bg-slate-900 border-t border-slate-700 flex items-center justify-center gap-3 md:gap-6 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] overflow-x-auto">
        <button onclick="openShop('domestic')" class="group relative px-3 md:px-6 py-1.5 md:py-2 bg-slate-800 hover:bg-emerald-900/30 text-emerald-400 rounded-xl border border-emerald-800 hover:border-emerald-500 transition-all transform hover:-translate-y-1 shrink-0">
            <div class="text-xs md:text-sm font-bold">ğŸ›’ åœ‹å…§äº¤æ˜“</div>
            <div class="text-[9px] md:text-[10px] opacity-70 hidden sm:block">è²·è³£è¨±å¯è­‰</div>
        </button>

        <button onclick="openShop('intl')" class="group relative px-3 md:px-6 py-1.5 md:py-2 bg-slate-800 hover:bg-blue-900/30 text-blue-400 rounded-xl border border-blue-800 hover:border-blue-500 transition-all transform hover:-translate-y-1 shrink-0">
            <div class="text-xs md:text-sm font-bold">âœˆï¸ åœ‹éš›å¸‚å ´</div>
            <div class="text-[9px] md:text-[10px] opacity-70 hidden sm:block">è³¼è²·é«˜ç´šç¢³æ¬Š</div>
        </button>
        <div class="w-px h-10 bg-slate-700 hidden md:block"></div>

        <button id="end-turn-btn" onclick="endTurn()" class="px-4 md:px-8 py-2 md:py-3 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transform transition active:scale-95 flex items-center gap-2 md:gap-3 border border-indigo-400 shrink-0">
            <span class="text-xs md:text-base">ğŸ“… çµæŸé€™ä¸€å¹´</span>
            <span class="bg-black/20 px-1.5 md:px-2 py-0.5 rounded text-[10px] md:text-xs hidden sm:inline">è¨ˆç®—ç‡Ÿæ”¶</span>
        </button>
    </footer>

                    <!-- MODAL: å»ºé€ å·¥å»  (ç°¡åŒ–ç‰ˆ) -->
                    <div id="build-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div
                            class="bg-slate-800 w-[450px] rounded-2xl shadow-2xl border-2 border-slate-600 overflow-hidden">
                            <div
                                class="bg-slate-900 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2" id="modal-title">
                                    ğŸ—ï¸ é¸æ“‡å»ºé€ é …ç›®
                                </h2>
                                <button onclick="closeModal('build-modal')"
                                    class="text-slate-400 hover:text-white text-xl">âœ•</button>
                            </div>

                            <div class="p-6 grid grid-cols-2 gap-4" id="build-options">
                                <!-- é¸é …æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
                            </div>

                            <!-- é¢¨éšªè©•ä¼°é è¦½å€ -->
                            <div class="bg-slate-900/50 p-4 mx-6 mb-6 rounded-xl border border-dashed border-slate-600">
                                <h3 class="text-xs text-slate-400 font-bold mb-2 uppercase">ğŸ¤– è‰¾ä¾çš„é¢¨éšªè©•ä¼°</h3>
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl"
                                        id="risk-icon">â”</div>
                                    <div class="text-sm">
                                        <div id="risk-text" class="text-slate-300">è«‹é¸æ“‡ä¸€å€‹å·¥å» ä¾†æŸ¥çœ‹åˆ†æ...</div>
                                        <div id="risk-profit" class="font-mono font-bold mt-1 text-white"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MODAL: å¹´åº¦é ’çå…¸ç¦® (çµç®—) -->
                    <div id="report-modal"
                        class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center">
                        <div
                            class="w-[500px] bg-white text-slate-900 rounded-2xl shadow-2xl overflow-hidden relative text-center animate-pop">
                            <!-- ç¶µå¸¶èƒŒæ™¯ -->
                            <div
                                class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/confetti.png')] opacity-10">
                            </div>

                            <div class="p-8">
                                <h2 class="text-3xl font-black text-indigo-900 mb-1 font-cartoon">ğŸ† å¹´åº¦é ’çå…¸ç¦® ğŸ†</h2>
                                <p class="text-slate-500 font-bold mb-6" id="report-year-label">2030 å¹´çµç®—å ±å‘Š</p>

                                <!-- é—œéµæ•¸æ“šå¡ç‰‡ -->
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="bg-emerald-100 p-4 rounded-xl border-2 border-emerald-200">
                                        <div class="text-xs text-emerald-600 font-bold uppercase">æœ¬å¹´æ·¨è³º (Profit)</div>
                                        <div class="text-2xl font-black text-emerald-600 font-mono mt-1"
                                            id="report-income">+
                                            $35,000
                                        </div>
                                    </div>
                                    <div class="bg-rose-100 p-4 rounded-xl border-2 border-rose-200">
                                        <div class="text-xs text-rose-600 font-bold uppercase">æ”¯ä»˜ç¢³è²» (Tax)</div>
                                        <div class="text-2xl font-black text-rose-600 font-mono mt-1" id="report-tax">-
                                            $5,000</div>
                                    </div>
                                </div>

                                <!-- æ’åèˆ‡æ¯”è¼ƒ -->
                                <div class="bg-slate-100 rounded-xl p-4 mb-6">
                                    <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-2">
                                        <span class="text-sm font-bold text-slate-600">ç›®å‰æ’å</span>
                                        <span class="text-xl font-black text-indigo-600" id="report-rank">ç¬¬ 2 å</span>
                                    </div>
                                    <div class="text-xs text-slate-500 text-left space-y-1" id="report-rank-detail">
                                        <p>ğŸ‘‘ ç¬¬ä¸€åï¼šæš´ç™¼æˆ¶é˜¿é‡‘ ($80,000)</p>
                                        <p>â˜ ï¸ æ±¡æŸ“ç‹ï¼šæš´ç™¼æˆ¶é˜¿é‡‘ (æ€ªç¸å¾ˆç”Ÿæ°£ï¼)</p>
                                    </div>
                                </div>

                                <button onclick="startNextTurn()"
                                    class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-lg rounded-xl shadow-lg transition transform hover:scale-105">
                                    ç¹¼çºŒä¸‹ä¸€å›åˆ âœ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- å»ºç¯‰ç®¡ç† Modal -->
                    <div id="building-management-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div
                            class="bg-slate-800 w-[450px] rounded-2xl shadow-2xl border-2 border-slate-600 overflow-hidden">
                            <div
                                class="bg-slate-900 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span id="bm-building-emoji">ğŸ­</span>
                                    <span id="bm-building-name">å»ºç¯‰ç®¡ç†</span>
                                </h2>
                                <button onclick="closeBuildingManagementModal()"
                                    class="text-slate-400 hover:text-white text-xl">âœ•</button>
                            </div>

                            <div class="p-6 space-y-4">
                                <!-- å»ºç¯‰è³‡è¨Š -->
                                <div class="bg-slate-900/50 p-4 rounded-xl">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-slate-400 text-xs mb-1">ç­‰ç´š</div>
                                            <div class="font-bold text-white" id="bm-building-level">ä¸€èˆ¬</div>
                                        </div>
                                        <div>
                                            <div class="text-slate-400 text-xs mb-1">å¹´æ”¶å…¥</div>
                                            <div class="font-bold text-emerald-400" id="bm-building-income">$0</div>
                                        </div>
                                        <div class="col-span-2">
                                            <div class="text-slate-400 text-xs mb-1">å¹´æ’æ”¾é‡</div>
                                            <div class="font-bold text-rose-400" id="bm-building-emission">0 å™¸</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å‡ç´šé¸é … -->
                                <div>
                                    <h3 class="text-sm font-bold text-slate-400 mb-2">å‡ç´šé¸é …</h3>
                                    <div id="bm-upgrade-options" class="flex gap-2 flex-wrap">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>

                                <!-- å‡ºå”®æŒ‰éˆ• -->
                                <button id="bm-sell-btn"
                                    class="w-full bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-lg font-bold">
                                    å‡ºå”®å»ºç¯‰
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤æ˜“å•†åº— Modal -->
                    <div id="shop-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[400px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2" id="shop-title">ğŸ›’ å•†åº—
                                </h2>
                                <button onclick="closeModal('shop-modal')"
                                    class="text-slate-400 hover:text-white">âœ•</button>
                            </div>

                            <div class="bg-slate-900 p-4 rounded-xl mb-4 text-center">
                                <div class="text-xs text-slate-400">ç›®å‰åƒ¹æ ¼</div>
                                <div class="text-3xl font-mono font-bold text-yellow-400" id="shop-price">$ 300</div>
                            </div>

                            <div class="grid grid-cols-2 gap-3" id="shop-actions">
                                <!-- JS Inject -->
                            </div>
                        </div>
                    </div>

                    <!-- ä¿å­˜/è¼‰å…¥ Modal -->
                    <div id="save-load-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[500px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">ğŸ’¾ ä¿å­˜/è¼‰å…¥éŠæˆ²</h2>
                                <button onclick="closeModal('save-load-modal')" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-sm font-bold text-slate-300 mb-2">å­˜æª”æ§½ä½</h3>
                                    <div id="save-slots" class="space-y-2">
                                        <!-- å‹•æ…‹ç”Ÿæˆå­˜æª”æ§½ä½ -->
                                    </div>
                                </div>
                                <div class="border-t border-slate-600 pt-4">
                                    <button onclick="autoSaveGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">
                                        è‡ªå‹•ä¿å­˜ï¼ˆæ§½ä½ 1ï¼‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æˆå°± Modal -->
                    <div id="achievement-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[600px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">ğŸ† æˆå°±ç³»çµ±</h2>
                                <button onclick="closeModal('achievement-modal')" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div id="achievement-progress" class="bg-slate-900 p-4 rounded-lg mb-4">
                                <!-- é€²åº¦çµ±è¨ˆ -->
                            </div>
                            <div id="achievement-list" class="space-y-2">
                                <!-- å‹•æ…‹ç”Ÿæˆæˆå°±åˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>

                    <!-- åœ°å¡Šè³¼è²· Modal -->
                    <div id="land-purchase-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[450px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">ğŸï¸ è³¼è²·åœ°å¡Š</h2>
                                <button onclick="closeModal('land-purchase-modal')" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div id="land-purchase-content">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- æ•¸æ“šé¢æ¿ Modal -->
                    <div id="data-panel-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[700px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">ğŸ“Š æ•¸æ“šé¢æ¿</h2>
                                <button onclick="closeModal('data-panel-modal')" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-sm font-bold text-slate-300 mb-2">ç¢³è²»è¨ˆç®—è©³æƒ…</h3>
                                    <div id="carbon-fee-breakdown" class="bg-slate-900 p-4 rounded-lg">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-slate-300 mb-2">æ’æ”¾ä¾†æºè¿½æº¯</h3>
                                    <div id="emission-source-trace" class="bg-slate-900 p-4 rounded-lg">
                                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é ­åƒæ›´æ› Modal -->
                    <div id="avatar-modal"
                        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[500px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">ğŸ–¼ï¸ æ›´æ›é ­åƒ</h2>
                                <button onclick="closeModal('avatar-modal')" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div class="space-y-4">
                                <p class="text-slate-300 text-sm">é¸æ“‡ä¸€å€‹é ­åƒæ¨£å¼ï¼š</p>
                                <div id="avatar-options" class="grid grid-cols-4 gap-4">
                                    <!-- å‹•æ…‹ç”Ÿæˆé ­åƒé¸é … -->
                                </div>
                                <div class="mt-4 pt-4 border-t border-slate-700">
                                    <p class="text-slate-400 text-xs mb-2">æˆ–è¼¸å…¥è‡ªè¨‚åç¨±ï¼š</p>
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-avatar-seed" placeholder="è¼¸å…¥åç¨±..." 
                                            class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                                        <button onclick="applyCustomAvatar()" 
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition">
                                            å¥—ç”¨
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éŠæˆ²çµæŸ Modal -->
                    <div id="game-over-modal"
                        class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center animate-pop">
                        <div class="bg-slate-800 w-[700px] rounded-2xl shadow-2xl border-2 border-slate-600 p-6 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-white flex items-center gap-2" id="game-over-title">ğŸ® éŠæˆ²çµæŸ</h2>
                                <button onclick="closeGameOverModal()" class="text-slate-400 hover:text-white">âœ•</button>
                            </div>
                            <div id="game-over-content">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            <div class="mt-6 flex gap-3">
                                <button onclick="restartGame()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">
                                    é‡æ–°é–‹å§‹
                                </button>
                                <button onclick="closeGameOverModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold">
                                    é—œé–‰
                                </button>
                            </div>
                        </div>
                    </div>

                    <script type="module">
                        // --- å°å…¥æ¨¡çµ„ ---
                        import { GAME_CONFIG, BUILDINGS, OWNER_CONFIG, FACTORY_LEVELS } from './js/core/GameConfig.js';
                        import { gameState } from './js/core/GameState.js';
                        import { CarbonFeeSystem } from './js/systems/CarbonFeeSystem.js';
                        import { LandSystem } from './js/systems/LandSystem.js';
                        import { BuildingSystem } from './js/systems/BuildingSystem.js';
                        import { TurnSystem } from './js/systems/TurnSystem.js';
                        import { NPCAISystem } from './js/systems/NPCAISystem.js';
                        import { SaveSystem } from './js/systems/SaveSystem.js';
                        import { AchievementSystem } from './js/systems/AchievementSystem.js';
                        import { DataPanel } from './js/ui/DataPanel.js';
                        import { TutorialSystem } from './js/ui/TutorialSystem.js';
                        import { VictorySystem } from './js/systems/VictorySystem.js';

                        // --- åˆå§‹åŒ–ç³»çµ± ---
                        const landSystem = new LandSystem();
                        const carbonFeeSystem = new CarbonFeeSystem(gameState, landSystem);
                        const buildingSystem = new BuildingSystem(gameState, carbonFeeSystem);
                        const turnSystem = new TurnSystem(gameState, carbonFeeSystem);
                        const saveSystem = new SaveSystem();
                        const achievementSystem = new AchievementSystem();
                        const dataPanel = new DataPanel();
                        const tutorialSystem = new TutorialSystem();
                        const victorySystem = new VictorySystem();
                        let npcAISystem = null; // åœ¨åˆå§‹åŒ–å¾Œå‰µå»º

        let selectedTileIndex = null;
        let isSettlementPending = false;

        function setEndTurnButtonDisabled(disabled) {
            const btn = document.getElementById('end-turn-btn');
            if (!btn) return;
            btn.disabled = disabled;
            if (disabled) {
                btn.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        // --- å»ºé€ é™åˆ¶è¼”åŠ©å‡½æ•¸ ---
        function getMaxBuildsPerTurn() {
            return GAME_CONFIG?.maxBuildingsPerTurn ?? Infinity;
        }

        function getCurrentBuildCount() {
            return gameState.buildingsBuiltThisTurn ?? 0;
        }

        function canPlayerBuild() {
            return getCurrentBuildCount() < getMaxBuildsPerTurn();
        }

        function incrementPlayerBuildCount() {
            gameState.buildingsBuiltThisTurn = getCurrentBuildCount() + 1;
        }

                        // --- Loading ç•«é¢æ§åˆ¶ ---
                        // æ ¹æ“šæ–¹å‘åˆ‡æ›åœ–ç‰‡
                        function updateLoadingImage() {
                            const portraitImg = document.querySelector('.loading-image-portrait');
                            const landscapeImg = document.querySelector('.loading-image-landscape');
                            
                            if (!portraitImg || !landscapeImg) return;

                            // ä½¿ç”¨ window.matchMedia æª¢æŸ¥æ–¹å‘
                            const isLandscape = window.matchMedia('(orientation: landscape)').matches;
                            
                            if (isLandscape) {
                                portraitImg.style.display = 'none';
                                landscapeImg.style.display = 'block';
                            } else {
                                portraitImg.style.display = 'block';
                                landscapeImg.style.display = 'none';
                            }
                        }

                        // ç›£è½æ–¹å‘è®ŠåŒ–
                        window.addEventListener('orientationchange', () => {
                            // å»¶é²ä¸€ä¸‹ç¢ºä¿æ–¹å‘å·²æ”¹è®Š
                            setTimeout(updateLoadingImage, 100);
                        });

                        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼ˆè™•ç†æŸäº›ç€è¦½å™¨çš„æ–¹å‘è®ŠåŒ–ï¼‰
                        window.addEventListener('resize', () => {
                            updateLoadingImage();
                        });

                        function hideLoadingScreen() {
                            const loadingScreen = document.getElementById('loading-screen');
                            if (!loadingScreen) return;

                            const loadingImage = loadingScreen.querySelector('.loading-image');
                            const minDisplayTime = 2000; // æœ€å°é¡¯ç¤ºæ™‚é–“ï¼š2 ç§’
                            const startTime = Date.now();

                            // ç¢ºä¿åœ–ç‰‡è¼‰å…¥å®Œæˆ
                            const imageLoaded = loadingImage ? new Promise((resolve) => {
                                if (loadingImage.complete) {
                                    resolve();
                                } else {
                                    loadingImage.addEventListener('load', resolve, { once: true });
                                    loadingImage.addEventListener('error', resolve, { once: true }); // å³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿç¹¼çºŒ
                                }
                            }) : Promise.resolve();

                            // ç­‰å¾…åœ–ç‰‡è¼‰å…¥å’Œæœ€å°é¡¯ç¤ºæ™‚é–“
                            Promise.all([
                                imageLoaded,
                                new Promise(resolve => setTimeout(resolve, minDisplayTime))
                            ]).then(() => {
                                // ç¢ºä¿è‡³å°‘é¡¯ç¤ºäº†æœ€å°æ™‚é–“
                                const elapsed = Date.now() - startTime;
                                const remaining = Math.max(0, minDisplayTime - elapsed);
                                
                                setTimeout(() => {
                                    loadingScreen.classList.add('hidden');
                                }, remaining);
                            });
                        }

                        // --- åˆå§‹åŒ– ---
                        document.addEventListener('DOMContentLoaded', () => {
                            // åˆå§‹åŒ– loading åœ–ç‰‡é¡¯ç¤º
                            updateLoadingImage();

                            // åˆå§‹åŒ–åœŸåœ°ç³»çµ±
                            landSystem.initializeLands(20, ['P', 'A', 'B', 'C']);

                            // åˆå§‹åŒ– NPC AI ç³»çµ±
                            npcAISystem = new NPCAISystem(gameState, carbonFeeSystem, landSystem);

                            // ç›£è½ç‹€æ…‹è®Šæ›´äº‹ä»¶
                            setupEventListeners();

                            // åˆå§‹åŒ–é ­åƒ
                            initAvatar();

                            initGrid();
                            updateUI();
                            updateMonsterVisuals(); // åˆå§‹åŒ–æ€ªç¸è¦–è¦º

                            // é è¨­çµ¦ç©å®¶ä¸€å€‹ç‡ƒç…¤å» ï¼ˆä¸è¨ˆå…¥å»ºé€ é™åˆ¶ï¼Œå› ç‚ºæ˜¯åˆå§‹å»ºç¯‰ï¼‰
                            addBuildingToTile(0, 'coal', 'P', 'Lv1');
                            // æ³¨æ„ï¼šåˆå§‹å»ºç¯‰ä¸è¨ˆå…¥ buildingsBuiltThisTurn

                            // æª¢æŸ¥æˆå°±
                            checkAchievements();

                            // å˜—è©¦è¼‰å…¥è‡ªå‹•å­˜æª”
                            if (saveSystem.hasAutoSave()) {
                                if (confirm('ç™¼ç¾è‡ªå‹•å­˜æª”ï¼Œæ˜¯å¦è¼‰å…¥ï¼Ÿ')) {
                                    loadGame(0);
                                } else {
                                    // æ²’æœ‰è¼‰å…¥å­˜æª”ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºæ•™å­¸
                                    setTimeout(() => {
                                        if (!tutorialSystem.completed) {
                                            if (confirm('æ­¡è¿ï¼é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡éŠç©å—ï¼Ÿæ˜¯å¦è¦é–‹å§‹æ–°æ‰‹æ•™å­¸ï¼Ÿ')) {
                                                tutorialSystem.start();
                                            }
                                        }
                                    }, 1000);
                                }
                            } else {
                                // æ²’æœ‰å­˜æª”ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºæ•™å­¸
                                setTimeout(() => {
                                    if (!tutorialSystem.completed) {
                                        if (confirm('æ­¡è¿ï¼é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡éŠç©å—ï¼Ÿæ˜¯å¦è¦é–‹å§‹æ–°æ‰‹æ•™å­¸ï¼Ÿ')) {
                                            tutorialSystem.start();
                                        }
                                    }
                                }, 1000);
                            }

                            // éš±è— loading ç•«é¢ï¼ˆç¢ºä¿åœ–ç‰‡è¼‰å…¥å®Œæˆä¸”è‡³å°‘é¡¯ç¤ºä¸€æ®µæ™‚é–“ï¼‰
                            hideLoadingScreen();
                        });

                        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                        function setupEventListeners() {
                            gameState.on('money.changed', () => updateUI());
                            gameState.on('emission.changed', () => {
                                updateUI();
                                updateMonsterVisuals();
                            });
                            gameState.on('monster.changed', () => {
                                updateUI();
                                updateMonsterVisuals();
                            });
                            gameState.on('monster.maxed', () => {
                                alert("æ€ªç¸æ‘§æ¯€äº†åŸå¸‚ï¼éŠæˆ²å¤±æ•—ï¼");
                                location.reload();
                            });
                            gameState.on('turn.changed', () => {
                                updateUI();
                            });
                        }

                        function onTileClick(index) {
                            // çœ‹é€™ä¸€æ ¼ä¸Šæœ‰æ²’æœ‰å»ºç¯‰
                            const building = gameState.getBuildingAtTile(index);

                            // æ²’æœ‰å»ºç¯‰ â†’ æª¢æŸ¥æ˜¯å¦å¯ä»¥è³¼è²·æˆ–å»ºé€ 
                            if (!building) {
                                const land = landSystem.getLand(index);
                                if (!land) {
                                    showToast('ç„¡æ•ˆçš„åœ°å¡Šï¼');
                                    return;
                                }

                                if (land.owner === 'P') {
                                    // ç©å®¶è‡ªå·±çš„åœ°å¡Šï¼Œå¯ä»¥å»ºé€ 
                                    openBuildModal(index);
                                } else {
                                    // å…¶ä»–ç©å®¶çš„åœ°å¡Šï¼Œå¯ä»¥è³¼è²·ï¼ˆå¦‚æœç¬¦åˆæ¢ä»¶ï¼‰
                                    const checkResult = landSystem.canPurchase(index, 'P', (tileIndex) => {
                                        return gameState.getBuildingAtTile(tileIndex) !== undefined;
                                    });
                                    
                                    if (checkResult.canPurchase) {
                                        openLandPurchaseModal(index);
                                    } else {
                                        showToast(checkResult.reason || 'ç„¡æ³•è³¼è²·æ­¤åœ°å¡Š');
                                    }
                                }
                                return;
                            }

                            // æœ‰å»ºç¯‰ï¼Œä½†ä¸æ˜¯ç©å®¶çš„ â†’ ä¸èƒ½å‹•ï¼Œåªçµ¦æç¤º
                            if (building.owner && building.owner !== 'P') {
                                const ownerLabel = OWNER_CONFIG[building.owner]?.label || 'å…¶ä»–å…¬å¸';
                                const buildingInfo = buildingSystem.getBuildingInfo(index);
                                if (buildingInfo) {
                                    showToast(
                                        `ã€Œ${ownerLabel}ã€çš„å·¥å» ï¼š${buildingInfo.name} (${buildingInfo.levelName})\n` +
                                        `æ’æ”¾ï¼š${buildingInfo.emission.toLocaleString()} å™¸/å¹´`
                                    );
                                } else {
                                    showToast(`é€™å¡Šåœ°æ˜¯ã€Œ${ownerLabel}ã€çš„å·¥å» ï¼Œä¸èƒ½è³£å–”ï¼`);
                                }
                                return;
                            }

                            // æœ‰å»ºç¯‰ä¸”æ˜¯ç©å®¶è‡ªå·±çš„ â†’ æ‰“é–‹å»ºç¯‰ç®¡ç†é¸å–®
                            openBuildingManagementModal(index);
                        }

                        // ç”Ÿæˆåœ°åœ–ï¼šåˆ†å€å¼è¨­è¨ˆ
                        function initGrid() {
                            const grid = document.getElementById('game-grid');
                            grid.innerHTML = '';

                            // ä½¿ç”¨ LandSystem ç²å–æ‰€æœ‰åœ°å¡Š
                            const lands = landSystem.getAllLands();
                            
                            // è¨ˆç®—ç¶²æ ¼å°ºå¯¸ï¼ˆç”¨æ–¼å®šä½å€åŸŸæ¨™è¨˜ï¼‰
                            // å‹•æ…‹ç²å–å¯¦éš›çš„åœ°å¡Šå°ºå¯¸ï¼Œè€Œä¸æ˜¯å›ºå®šå€¼ï¼ˆéŸ¿æ‡‰å¼ï¼‰
                            const cols = 5; // 5åˆ—ï¼š4å€‹ä¼æ¥­å„ä¸€åˆ— + 1åˆ—æ··åˆ
                            const rows = 4; // 4è¡Œ
                            
                            // æ ¹æ“šè¢å¹•å¯¬åº¦å‹•æ…‹åˆ¤æ–·åœ°å¡Šå°ºå¯¸
                            let tileWidth = 96; // é è¨­å€¼ï¼ˆæ¡Œé¢ç«¯ï¼š6rem = 96pxï¼‰
                            let tileHeight = 96;
                            let gap = 6; // é è¨­å€¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
                            let gridPadding = 20; // é è¨­å€¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
                            
                            const screenWidth = window.innerWidth;
                            if (screenWidth <= 480) {
                                // å°è¢å¹•æ‰‹æ©Ÿ
                                tileWidth = 40;
                                tileHeight = 40;
                                gap = 3;
                                gridPadding = 8;
                            } else if (screenWidth <= 768) {
                                // æ‰‹æ©Ÿ/å¹³æ¿
                                tileWidth = 50;
                                tileHeight = 50;
                                gap = 4;
                                gridPadding = 10;
                            }
                            
                            // å¦‚æœåœ°å¡Šå·²ç¶“å­˜åœ¨ï¼Œä½¿ç”¨å¯¦éš›è¨ˆç®—çš„å°ºå¯¸ï¼ˆæ›´æº–ç¢ºï¼‰
                            // æ³¨æ„ï¼šé€™éœ€è¦åœ¨æ‰€æœ‰åœ°å¡Šå‰µå»ºå¾ŒåŸ·è¡Œï¼Œæ‰€ä»¥å…ˆç”¨ä¸Šé¢çš„ä¼°ç®—å€¼

                            // å‰µå»ºå€åŸŸèƒŒæ™¯å’Œæ¨™ç±¤ï¼ˆå‰4åˆ—ï¼šæ¯å€‹ä¼æ¥­å„ä¸€åˆ—ï¼‰
                            const zoneConfigs = [
                                { key: 'P', name: 'ç©å®¶å€åŸŸ', bgClass: 'zone-bg-player', col: 0 },
                                { key: 'A', name: 'NPC A å€åŸŸ', bgClass: 'zone-bg-npc-a', col: 1 },
                                { key: 'B', name: 'NPC B å€åŸŸ', bgClass: 'zone-bg-npc-b', col: 2 },
                                { key: 'C', name: 'NPC C å€åŸŸ', bgClass: 'zone-bg-npc-c', col: 3 }
                            ];

                            // ç‚ºæ¯å€‹å€åŸŸæ·»åŠ èƒŒæ™¯ï¼ˆå‰4åˆ—ï¼‰
                            zoneConfigs.forEach(zone => {
                                const zoneBg = document.createElement('div');
                                zoneBg.className = `zone-bg ${zone.bgClass}`;
                                const left = gridPadding + zone.col * (tileWidth + gap);
                                const top = gridPadding;
                                const width = tileWidth + gap * 2;
                                const height = rows * (tileHeight + gap) - gap;
                                zoneBg.style.cssText = `left: ${left}px; top: ${top}px; width: ${width}px; height: ${height}px;`;
                                grid.appendChild(zoneBg);

                                // æ·»åŠ å€åŸŸæ¨™ç±¤ï¼ˆåœ¨å€åŸŸé ‚éƒ¨ä¸­å¤®ï¼‰
                                const zoneLabel = document.createElement('div');
                                zoneLabel.className = 'zone-label';
                                zoneLabel.textContent = zone.name;
                                zoneLabel.style.cssText = `left: ${left + width / 2}px; top: ${top - 12}px; transform: translateX(-50%);`;
                                grid.appendChild(zoneLabel);
                            });

                            // ç‚ºç¬¬5åˆ—ï¼ˆæ··åˆå€åŸŸï¼‰æ·»åŠ æ¨™ç±¤
                            const mixedZoneCol = 4;
                            const mixedZoneLabel = document.createElement('div');
                            mixedZoneLabel.className = 'zone-label';
                            mixedZoneLabel.textContent = 'æ··åˆå€åŸŸ';
                            mixedZoneLabel.style.cssText = `left: ${gridPadding + mixedZoneCol * (tileWidth + gap) + tileWidth / 2}px; top: ${gridPadding - 12}px; transform: translateX(-50%);`;
                            grid.appendChild(mixedZoneLabel);

                            // æ·»åŠ å‚ç›´åˆ†éš”ç·šï¼ˆåœ¨æ‰€æœ‰åˆ—ä¹‹é–“ï¼‰
                            for (let i = 1; i < cols; i++) {
                                const divider = document.createElement('div');
                                divider.className = 'zone-divider-vertical';
                                const left = gridPadding + i * (tileWidth + gap) - gap / 2;
                                divider.style.cssText = `left: ${left}px;`;
                                grid.appendChild(divider);
                            }

                            // æ·»åŠ æ°´å¹³åˆ†éš”ç·šï¼ˆåœ¨è¡Œä¹‹é–“ï¼‰
                            for (let i = 1; i < rows; i++) {
                                const divider = document.createElement('div');
                                divider.className = 'zone-divider-horizontal';
                                const top = gridPadding + i * (tileHeight + gap) - gap / 2;
                                divider.style.cssText = `top: ${top}px;`;
                                grid.appendChild(divider);
                            }

                            // ç”Ÿæˆåœ°å¡Š
                            lands.forEach(land => {
                                const visualInfo = landSystem.getLandVisualInfo(land.index);
                                const owner = OWNER_CONFIG[land.owner];
                                const clickable = land.owner === 'P';

                                // å‰µå»ºåœ°å¡Šå®¹å™¨
                                const tile = document.createElement('div');
                                tile.dataset.index = land.index;
                                tile.dataset.owner = land.owner;
                                tile.dataset.zone = land.zone || land.owner;
                                tile.className = `tile-3d-base ${clickable ? 'cursor-pointer' : 'cursor-not-allowed opacity-90'}`;

                                // ç°¡æ½”çš„ 2D åœ°å¡Šçµæ§‹
                                const borderColor = visualInfo.borderClass.includes('yellow') ? '#facc15' : 
                                                   visualInfo.borderClass.includes('rose') ? '#f43f5e' : 
                                                   visualInfo.borderClass.includes('sky') ? '#0ea5e9' : 
                                                   visualInfo.borderClass.includes('amber') ? '#f59e0b' : '#64748b';
                                
                                tile.innerHTML = `
                                    <div class="tile-top ${visualInfo.bgClass} border-2 flex items-center justify-center" style="border-color: ${borderColor};">
                                        <div class="absolute top-1 left-1 text-[9px] px-1.5 py-0.5 rounded-full text-black ${visualInfo.ownerBadge} font-bold z-10">
                        ${owner.badgeText}
                    </div>
                                        <div class="text-2xl" title="${visualInfo.tooltip}">
                        ${visualInfo.emoji}
                    </div>
                                        ${land.owner === 'P' ? '<span class="absolute bottom-1 right-1 text-[10px] text-emerald-400 font-bold">+</span>' : ''}
                                    </div>
                `;

                                if (clickable) {
                                    tile.onclick = () => onTileClick(land.index);
                                } else {
                                    tile.onclick = () => showToast(`${owner.tooltip}ï¼Œä½ ä¸èƒ½åœ¨é€™è£¡è“‹å·¥å» ï¼`);
                                }

                                grid.appendChild(tile);
                            });
                        }

                        // --- æ ¸å¿ƒé‚è¼¯ ---

                        /**
                         * ç”Ÿæˆç°¡æ½”çš„ 2D å»ºç¯‰ HTML
                         */
                        function generateBuilding3D(buildingType, ownerKey, level) {
                            const b = BUILDINGS[buildingType];
                            if (!b) return '';
                            
                            const owner = OWNER_CONFIG[ownerKey];
                            const levelBadge = level !== 'Lv1' ? `<div class="absolute top-1 right-1 text-[8px] bg-blue-600 text-white px-1 rounded z-20 font-bold">${level}</div>` : '';
                            
                            return `
                                <div class="flex flex-col items-center justify-center h-full relative">
                                    <div class="text-3xl animate-pop">${b.emoji}</div>
                                    <div class="text-[10px] font-bold text-slate-300 mt-1">${b.name}</div>
                                    ${b.type === 'high_pollute' ? '<div class="absolute bottom-1 right-1 text-[8px] text-rose-400 animate-pulse">â˜ï¸</div>' : ''}
                                    ${levelBadge}
                                </div>
                            `;
                        }

                        function addBuildingToTile(index, typeId, ownerKey = 'P', level = 'Lv1') {
                            const grid = document.getElementById('game-grid');
                            // ä½¿ç”¨ dataset.index æŸ¥æ‰¾åœ°å¡Šï¼Œè€Œä¸æ˜¯ä¾è³´ children é †åº
                            const tile = Array.from(grid.children).find(t => t.dataset.index == index);
                            if (!tile) {
                                // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                                if (window.DEBUG_MODE) console.warn('ç„¡æ³•æ‰¾åˆ°åœ°å¡Š:', index);
                                return;
                            }
                            
                            const b = BUILDINGS[typeId];
                            if (!b) {
                                // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                                if (window.DEBUG_MODE) console.warn('ç„¡æ•ˆçš„å»ºç¯‰é¡å‹:', typeId);
                                return;
                            }

                            // ä½¿ç”¨ GameState æ·»åŠ å»ºç¯‰
                            gameState.addBuilding({
                                type: typeId,
                                tileIndex: index,
                                owner: ownerKey,
                                level: level
                            });

                            // ä½¿ç”¨ updateTileVisual ä¾†æ›´æ–°è¦–è¦ºï¼Œç¢ºä¿ä¸€è‡´æ€§
                            updateTileVisual(index);
                        }

                        function recalcStats() {
                            // ä½¿ç”¨ CarbonFeeSystem è¨ˆç®—å¯¦éš›æ’æ”¾é‡
                            const totalEmission = carbonFeeSystem.calculateTotalEmission('P');
                            gameState.setEmission(totalEmission);

                            // è¨ˆç®—æ”¶å…¥
                            let totalIncome = 0;
                            gameState.getPlayerBuildings().forEach(b => {
                                const data = BUILDINGS[b.type];
                                if (data) {
                                    totalIncome += data.income;
                                }
                            });

                            gameState.projectedIncome = totalIncome;
                        }

                        // æ‰“é–‹å»ºç¯‰ç®¡ç†æ¨¡æ…‹æ¡†ï¼ˆå‡ç´š/å‡ºå”®ï¼‰
                        function openBuildingManagementModal(index) {
                            // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°æ—¥èªŒ
                            if (window.DEBUG_MODE) {
                                console.log('openBuildingManagementModal called with index:', index);
                            }
                            const buildingInfo = buildingSystem.getBuildingInfo(index);
                            if (window.DEBUG_MODE) {
                                console.log('buildingInfo:', buildingInfo);
                            }

                            if (!buildingInfo) {
                                showToast('ç„¡æ³•ç²å–å»ºç¯‰è³‡è¨Š');
                                return;
                            }

                            if (buildingInfo.owner !== 'P') {
                                showToast('é€™ä¸æ˜¯ä½ çš„å»ºç¯‰ï¼');
                                return;
                            }

                            selectedTileIndex = index;
                            const modal = document.getElementById('building-management-modal');
                            if (window.DEBUG_MODE) {
                                console.log('modal element:', modal);
                            }

                            if (!modal) {
                                showToast('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å»ºç¯‰ç®¡ç†æ¨¡æ…‹æ¡†ï¼');
                                if (window.DEBUG_MODE) {
                                    console.error('building-management-modal not found!');
                                }
                                return;
                            }

                            // æ›´æ–°æ¨¡æ…‹æ¡†å…§å®¹
                            document.getElementById('bm-building-name').innerText = buildingInfo.name;
                            document.getElementById('bm-building-emoji').innerText = buildingInfo.emoji;
                            document.getElementById('bm-building-level').innerText = buildingInfo.levelName;
                            document.getElementById('bm-building-income').innerText = `$${buildingInfo.income.toLocaleString()}/å¹´`;
                            document.getElementById('bm-building-emission').innerText = `${buildingInfo.emission.toLocaleString()} å™¸/å¹´`;

                            // å‡ç´šé¸é …
                            const upgradeContainer = document.getElementById('bm-upgrade-options');
                            upgradeContainer.innerHTML = '';

                            if (buildingInfo.canUpgrade && buildingInfo.upgradeOptions.length > 0) {
                                buildingInfo.upgradeOptions.forEach(option => {
                                    const btn = document.createElement('button');
                                    btn.className = 'bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold';
                                    btn.innerHTML = `
                        <div>å‡ç´šåˆ° ${option.name}</div>
                        <div class="text-xs opacity-80">$${option.cost.toLocaleString()}</div>
                    `;
                                    btn.onclick = () => upgradeBuilding(index, option.level);
                                    upgradeContainer.appendChild(btn);
                                });
                            } else {
                                upgradeContainer.innerHTML = '<p class="text-slate-400 text-sm">ç„¡æ³•å‡ç´š</p>';
                            }

                            // å‡ºå”®æŒ‰éˆ•
                            const sellBtn = document.getElementById('bm-sell-btn');
                            const refund = buildingSystem.calculateRefund(index);
                            sellBtn.innerHTML = `
                <div>å‡ºå”®å»ºç¯‰</div>
                <div class="text-xs opacity-80">å›æ”¶ $${refund.toLocaleString()}</div>
            `;
                            sellBtn.onclick = () => {
                                const buildingData = BUILDINGS[buildingInfo.type];
                                const isHighPollute = buildingData && buildingData.type === 'high_pollute';
                                const confirmMsg = isHighPollute 
                                    ? `ç¢ºå®šè¦å‡ºå”®ã€Œ${buildingInfo.name}ã€å—ï¼Ÿ\nå¯å›æ”¶ï¼š$${refund.toLocaleString()}\n\nâš ï¸ é€™æ˜¯é«˜æ’æ”¾å»ºç¯‰ï¼Œæ‹†é™¤å¾Œå¯ä»¥é™ä½æ€ªç¸æ€’æ°£å€¼ï¼`
                                    : `ç¢ºå®šè¦å‡ºå”®ã€Œ${buildingInfo.name}ã€å—ï¼Ÿ\nå¯å›æ”¶ï¼š$${refund.toLocaleString()}`;
                                
                                if (confirm(confirmMsg)) {
                                    const result = buildingSystem.sellBuilding(index, 'P');
                                    if (result.success) {
                                        showToast(result.message);
                                        closeBuildingManagementModal();
                                        // æ›´æ–°åœ°å¡Šè¦–è¦º
                                        updateTileVisual(index);
                                        recalcStats();
                                        // æ›´æ–°æ€ªç¸è¦–è¦ºï¼ˆå¦‚æœé™ä½äº†æ€’æ°£å€¼ï¼‰
                                        if (result.monsterReduction > 0) {
                                            updateMonsterVisuals();
                                            updateUI();
                                        }
                                    } else {
                                        showToast(result.message);
                                    }
                                }
                            };

                            modal.classList.remove('hidden');
                            // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°æ—¥èªŒ
                            if (window.DEBUG_MODE) {
                                console.log('Modal should be visible now');
                            }

                            // ç¢ºä¿æ¨¡æ…‹æ¡†é¡¯ç¤ºåœ¨æœ€ä¸Šå±¤
                            modal.style.zIndex = '60';
                        }

                        function closeBuildingManagementModal() {
                            const modal = document.getElementById('building-management-modal');
                            if (modal) {
                                modal.classList.add('hidden');
                            }
                        }

                        function upgradeBuilding(index, targetLevel) {
                            const result = buildingSystem.upgradeBuilding(index, 'P', targetLevel);
                            if (result.success) {
                                showToast(result.message);
                                closeBuildingManagementModal();
                                // æ›´æ–°åœ°å¡Šè¦–è¦º
                                updateTileVisual(index);
                                recalcStats();
                                
                                // æª¢æŸ¥æ•™å­¸é€²åº¦
                                tutorialSystem.checkAction('wait_upgrade');
                            } else {
                                showToast(result.message);
                            }
                        }

                        function updateTileVisual(index) {
                            const tile = document.querySelector(`#game-grid > div[data-index="${index}"]`);
                            if (!tile) return;

                            const building = gameState.getBuildingAtTile(index);
                            if (building) {
                                // æœ‰å»ºç¯‰ï¼Œæ›´æ–°ç‚º 3D è¦–è¦º
                                const buildingData = BUILDINGS[building.type];
                                const owner = OWNER_CONFIG[building.owner];
                                const land = landSystem.getLand(index);
                                const landVisual = landSystem.getLandVisualInfo(index);

                                let bgClass = landVisual.bgClass;
                                if (buildingData.type === 'clean') {
                                    bgClass = 'bg-emerald-900/50';
                                } else if (buildingData.type === 'high_pollute') {
                                    bgClass = 'bg-rose-900/50';
                                }

                                const ownerBorderColor = owner.color.includes('yellow') ? '#facc15' : 
                                                        owner.color.includes('rose') ? '#f43f5e' : 
                                                        owner.color.includes('sky') ? '#0ea5e9' : 
                                                        owner.color.includes('amber') ? '#f59e0b' : '#64748b';

                                // ç¢ºä¿åœ°å¡Šçµæ§‹æ­£ç¢º
                                if (!tile.classList.contains('tile-3d-base')) {
                                    tile.className = `tile-3d-base ${building.owner === 'P' ? 'cursor-pointer' : 'cursor-default'}`;
                                }

                                // æ›´æ–°åœ°å¡Š
                                let tileTop = tile.querySelector('.tile-top');
                                if (!tileTop) {
                                    // å¦‚æœæ²’æœ‰é ‚é¢ï¼Œé‡æ–°å‰µå»ºæ•´å€‹çµæ§‹
                                    tile.innerHTML = `<div class="tile-top ${bgClass} border-2 flex flex-col items-center justify-center"></div>`;
                                    tileTop = tile.querySelector('.tile-top');
                                }

                                tileTop.className = `tile-top ${bgClass} border-2 flex flex-col items-center justify-center`;
                                tileTop.style.borderColor = ownerBorderColor;
                                tileTop.innerHTML = `
                                    <div class="absolute top-1 left-1 text-[9px] px-1.5 py-0.5 rounded-full text-black ${owner.badgeBg} font-bold z-20">
                        ${owner.badgeText}
                    </div>
                                    ${generateBuilding3D(building.type, building.owner, building.level || 'Lv1')}
                                `;

                                // æ›´æ–°é»æ“Šäº‹ä»¶
                                if (building.owner === 'P') {
                                tile.onclick = (e) => {
                                    e.stopPropagation();
                                        openBuildingManagementModal(index);
                                    };
                                    tile.style.cursor = 'pointer';
                                    } else {
                                    tile.onclick = (e) => {
                                        e.stopPropagation();
                                        showToast(`${owner.name} çš„å·¥å» ï¼š${buildingData.name}`);
                                };
                                    tile.style.cursor = 'default';
                                }
                            } else {
                                // æ²’æœ‰å»ºç¯‰ï¼Œæ¢å¾©ç‚º 3D ç©ºåœ°
                                const land = landSystem.getLand(index);
                                const visualInfo = landSystem.getLandVisualInfo(index);
                                const owner = OWNER_CONFIG[land.owner];
                                const clickable = land.owner === 'P';

                                tile.className = `tile-3d-base ${clickable ? 'cursor-pointer' : 'cursor-not-allowed opacity-90'}`;
                                
                                const ownerBorderColor = owner.color.includes('yellow') ? '#facc15' : 
                                                        owner.color.includes('rose') ? '#f43f5e' : 
                                                        owner.color.includes('sky') ? '#0ea5e9' : 
                                                        owner.color.includes('amber') ? '#f59e0b' : '#64748b';

                                tile.innerHTML = `
                                    <div class="tile-top ${visualInfo.bgClass} border-2 flex items-center justify-center" style="border-color: ${ownerBorderColor};">
                                        <div class="absolute top-1 left-1 text-[9px] px-1.5 py-0.5 rounded-full text-black ${visualInfo.ownerBadge} font-bold z-10">
                        ${owner.badgeText}
                    </div>
                                        <div class="text-2xl" title="${visualInfo.tooltip}">
                        ${visualInfo.emoji}
                    </div>
                                        ${land.owner === 'P' ? '<span class="absolute bottom-1 right-1 text-[10px] text-emerald-400 font-bold">+</span>' : ''}
                                    </div>
                `;

                                tile.onclick = clickable
                                    ? () => onTileClick(index)
                                    : () => showToast(`${owner.tooltip}ï¼Œä½ ä¸èƒ½åœ¨é€™è£¡è“‹å·¥å» ï¼`);
                            }
                        }

                        /**
                         * æ¸›ç¢³æŠ•è³‡åŠŸèƒ½
                         */
                        function investInCarbonReduction() {
                            const baseCost = 15000;
                            // æ ¹æ“šç•¶å‰æ€’æ°£å€¼è¨ˆç®—é™ä½å€¼ï¼ˆ3-8%ï¼‰
                            const reduction = 3 + Math.floor(gameState.monsterAnger / 20);
                            
                            if (gameState.money < baseCost) {
                                showToast('âŒ è³‡é‡‘ä¸è¶³ï¼éœ€è¦ $15,000 æ‰èƒ½æŠ•è³‡æ¸›ç¢³æŠ€è¡“');
                                return;
                            }

                            if (gameState.monsterAnger <= 0) {
                                showToast('âœ… æ€ªç¸æ€’æ°£å€¼å·²ç¶“å¾ˆä½äº†ï¼Œä¸éœ€è¦æŠ•è³‡ï¼');
                                return;
                            }

                            if (confirm(`ç¢ºå®šè¦æŠ•è³‡æ¸›ç¢³æŠ€è¡“å—ï¼Ÿ\n\nèŠ±è²»ï¼š$${baseCost.toLocaleString()}\næ•ˆæœï¼šé™ä½æ€ªç¸æ€’æ°£å€¼ ${reduction}%\n\né€™å°‡å¹«åŠ©åŸå¸‚æ¸›å°‘æ’æ”¾ï¼Œè®“æ€ªç¸é é›¢ï¼`)) {
                                gameState.subtractMoney(baseCost);
                                gameState.reduceMonsterAnger(reduction);
                                
                                showToast(`âœ… æŠ•è³‡æ¸›ç¢³æŠ€è¡“æˆåŠŸï¼\næ€ªç¸æ€’æ°£å€¼é™ä½ ${reduction}%ï¼\nä½ çš„æ¸›ç¢³åŠªåŠ›å¾—åˆ°å›å ±ï¼`);
                                
                                updateUI();
                                updateMonsterVisuals();
                            }
                        }

                        function updateUI() {
                            // Money
                            animateValue('player-money', gameState.money, '$');
                            
                            // æ›´æ–°æ¸›ç¢³æŠ•è³‡æŒ‰éˆ•ç‹€æ…‹
                            const carbonBtn = document.getElementById('carbon-investment-btn');
                            if (carbonBtn) {
                                const canAfford = gameState.money >= 15000;
                                const isEffective = gameState.monsterAnger > 0;
                                carbonBtn.disabled = !canAfford || !isEffective;
                                
                                // æ ¹æ“šæ€’æ°£å€¼æ›´æ–°æŒ‰éˆ•æ–‡å­—
                                if (gameState.monsterAnger >= 70) {
                                    carbonBtn.className = 'mt-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed animate-pulse';
                                    carbonBtn.title = 'âš ï¸ ç·Šæ€¥ï¼æ€ªç¸æ­£åœ¨æ¥è¿‘ï¼æŠ•è³‡æ¸›ç¢³æŠ€è¡“å¯ä»¥é™ä½ ' + (3 + Math.floor(gameState.monsterAnger / 20)) + '% æ€’æ°£å€¼';
                                } else {
                                    carbonBtn.className = 'mt-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed';
                                    carbonBtn.title = 'æŠ•è³‡æ¸›ç¢³æŠ€è¡“ï¼Œé™ä½æ€ªç¸æ€’æ°£å€¼ ' + (3 + Math.floor(gameState.monsterAnger / 20)) + '%';
                                }
                            }

                            // Emission & Status - ä½¿ç”¨ CarbonFeeSystem è¨ˆç®—
                            const totalEmission = carbonFeeSystem.calculateTotalEmission('P');
                            document.getElementById('current-emission').innerText = totalEmission.toLocaleString();
                            const statusBadge = document.getElementById('emission-status');

                            // ç´…å€é–¾å€¼èª¿æ•´ç‚ºå…å¾µé¡åº¦çš„ 2.5 å€
                            const redZoneThreshold = GAME_CONFIG.freeEmission * 2.5;
                            if (totalEmission > redZoneThreshold) {
                                statusBadge.innerText = "å±éšª (ç´…å€)";
                                statusBadge.className = "bg-rose-900 text-rose-200 text-[10px] px-2 py-0.5 rounded border border-rose-600 animate-pulse";
                                speak("å–”ä¸ï¼ç¾åœ¨æ˜¯ç´…å€ï¼æ€ªç¸æœƒè¢«å¸å¼•éä¾†ï¼Œè€Œä¸”ä½ è¦ä»˜å¾ˆå¤šéŒ¢ï¼");
                            } else if (totalEmission > GAME_CONFIG.freeEmission) {
                                statusBadge.innerText = "æ”¶è²»ä¸­ (é»ƒå€)";
                                statusBadge.className = "bg-yellow-900 text-yellow-200 text-[10px] px-2 py-0.5 rounded border border-yellow-600";
                                speak("æ³¨æ„ï¼è¶…éå…ç¨…é¡äº†ï¼Œæ¯ä¸€å™¸éƒ½è¦ä»˜éŒ¢å–”ï¼");
                            } else {
                                statusBadge.innerText = "å®‰å…¨ (ç¶ å€)";
                                statusBadge.className = "bg-emerald-900 text-emerald-200 text-[10px] px-2 py-0.5 rounded border border-emerald-600";
                            }

            // æ›´æ–°å…ç¨…é¡é¡¯ç¤º
            const freeEmissionDisplay = document.getElementById('free-emission-display');
            const redZoneDisplay = document.getElementById('red-zone-display');
            if (freeEmissionDisplay) {
                freeEmissionDisplay.textContent = `${Math.floor(GAME_CONFIG.freeEmission / 1000)}k (å…ç¨…é¡)`;
            }
            if (redZoneDisplay) {
                redZoneDisplay.textContent = `${Math.floor(GAME_CONFIG.freeEmission * 2.5 / 1000)}k`;
            }

                            // Credits
                            document.getElementById('local-credits').innerText = gameState.domesticCredits;
                            document.getElementById('intl-credits').innerText = gameState.intlCredits;

                            // Prices
                            document.getElementById('domestic-price').innerText = gameState.domesticPrice;
                            document.getElementById('intl-price').innerText = gameState.intlPrice;

                            // Header å¹´ä»½ / å›åˆ
                            document.getElementById('header-year').innerText = `${gameState.year} å¹´`;
                            document.getElementById('header-turn').innerText = `ç¬¬ ${gameState.turn} / ${GAME_CONFIG.maxYears} å›åˆ`;

                            // æ€ªç¸æ€’æ°£æ¢ï¼ˆæ¡Œé¢ç«¯ï¼‰
                            const monsterBar = document.getElementById('monster-bar');
                            if (monsterBar) {
                                monsterBar.style.width = Math.min(gameState.monsterAnger, 100) + '%';
                                if (gameState.monsterAnger > 70) {
                                    monsterBar.classList.add('from-rose-500', 'to-rose-900');
                                }
                            }

                            // æ€ªç¸æ€’æ°£æ¢ï¼ˆæ‰‹æ©Ÿç«¯ï¼‰
                            const monsterBarMobile = document.getElementById('monster-bar-mobile');
                            const monsterAngerMobile = document.getElementById('monster-anger-mobile');
                            if (monsterBarMobile) {
                                monsterBarMobile.style.width = Math.min(gameState.monsterAnger, 100) + '%';
                            }
                            if (monsterAngerMobile) {
                                monsterAngerMobile.textContent = Math.round(gameState.monsterAnger) + '%';
                            }

                            // æ›´æ–°æ‰‹æ©Ÿç«¯æ¸›ç¢³æŠ•è³‡æŒ‰éˆ•
                            const carbonBtnMobile = document.getElementById('carbon-investment-btn-mobile');
                            if (carbonBtnMobile) {
                                const canAfford = gameState.money >= 15000;
                                const isEffective = gameState.monsterAnger > 0;
                                carbonBtnMobile.disabled = !canAfford || !isEffective;
                            }

                            updateNPCUI();
                        }

                        function updateMonsterVisuals() {
                            const anger = gameState.monsterAnger;
                            const container = document.getElementById('monster-approach-container');
                            const monsterBody = document.getElementById('monster-body-3d');
                            const monsterGlow = document.getElementById('monster-glow-3d');
                            const warningEdge = document.getElementById('monster-warning-edge');
                            const skyBackground = document.getElementById('sky-background');

                            if (!container) return;

                            // æ ¹æ“šæ€’æ°£å€¼ç¢ºå®šéšæ®µ
                            let stage = 'monster-stage-1';
                            if (anger >= 90) {
                                stage = 'monster-stage-5';
                            } else if (anger >= 70) {
                                stage = 'monster-stage-4';
                            } else if (anger >= 50) {
                                stage = 'monster-stage-3';
                            } else if (anger >= 30) {
                                stage = 'monster-stage-2';
                            }

                            // æ›´æ–°å®¹å™¨é¡åˆ¥
                            container.className = `monster-approach-container ${stage}`;

                            // æ›´æ–°æ€ªç¸é¡è‰²å’Œå…‰æ•ˆ
                            if (anger > 50) {
                                if (monsterBody) {
                                    monsterBody.style.background = `radial-gradient(circle, #dc2626, #991b1b)`;
                                    monsterBody.style.boxShadow = `0 0 40px rgba(220, 38, 38, 1), inset 0 0 30px rgba(0,0,0,0.5)`;
                                }
                                if (monsterGlow) {
                                    monsterGlow.style.background = '#dc2626';
                                    monsterGlow.style.opacity = Math.min(0.6, 0.3 + (anger / 200));
                                }
                            } else {
                                if (monsterBody) {
                                    monsterBody.style.background = `radial-gradient(circle, #475569, #1f2937)`;
                                    monsterBody.style.boxShadow = `0 0 30px rgba(71, 85, 105, 0.8), inset 0 0 20px rgba(0,0,0,0.5)`;
                                }
                                if (monsterGlow) {
                                    monsterGlow.style.background = '#6366f1';
                                    monsterGlow.style.opacity = 0.2;
                                }
                            }

                            // æ›´æ–°å±å¹•é‚Šç·£è­¦å‘Š
                            if (warningEdge) {
                                if (anger >= 50) {
                                    warningEdge.classList.add('active');
                                    const width = Math.min(200, 50 + (anger - 50) * 3);
                                    warningEdge.style.width = `${width}px`;
                                } else {
                                    warningEdge.classList.remove('active');
                                    warningEdge.style.width = '0px';
                                }
                            }

                            // æ›´æ–°å¤©ç©ºèƒŒæ™¯ï¼ˆæ ¹æ“šæ€’æ°£å€¼è®Šç´…ï¼‰
                            if (skyBackground) {
                                const redIntensity = Math.min(0.6, (anger / 100) * 0.6);
                                const skyGradient = skyBackground.querySelector('div');
                                if (skyGradient) {
                                    skyGradient.style.background = `linear-gradient(to bottom, rgba(220, 38, 38, ${redIntensity}), rgba(127, 29, 29, ${redIntensity * 0.5}), rgba(30, 41, 59, 1))`;
                                }
                            }

                            // é«˜æ€’æ°£å€¼æ™‚çš„éœ‡å‹•æ•ˆæœ
                            if (anger >= 70) {
                                document.body.style.animation = anger >= 90 
                                    ? 'screen-shake 0.1s ease-in-out infinite' 
                                    : 'screen-shake 0.3s ease-in-out infinite';
                            } else {
                                document.body.style.animation = '';
                            }
                        }

                        function updateNPCUI() {
                            // ç”¨ emission / money çš„ç›¸å°æ¯”ä¾‹æ›´æ–° NPC å°æ¢
                            const npcKeys = ['A', 'B', 'C'];
                            
                            // è¨ˆç®—æ‰€æœ‰NPCçš„å¯¦éš›æ’æ”¾é‡ï¼ˆä½¿ç”¨CarbonFeeSystemï¼‰
                            const npcEmissions = npcKeys.map(k => carbonFeeSystem.calculateTotalEmission(k));
                            const maxE = Math.max(1, ...npcEmissions);

                            ['A', 'B', 'C'].forEach((key, index) => {
                                const npc = gameState.competitors[key];
                                const bar = document.getElementById(`npc${key}-bar`);
                                const label = document.getElementById(`npc${key}-emission-label`);
                                
                                // è¨ˆç®—å¯¦éš›æ’æ”¾é‡
                                const actualEmission = carbonFeeSystem.calculateTotalEmission(key);
                                
                                // æ›´æ–°è³‡é‡‘é¡¯ç¤º
                                const moneyEl = document.getElementById(`npc${key}-money`);
                                if (moneyEl) {
                                    moneyEl.textContent = `$${npc.money.toLocaleString()}`;
                                }
                                
                                // æ›´æ–°ç¢³æ’æ”¾é¡¯ç¤º
                                const emissionEl = document.getElementById(`npc${key}-emission`);
                                if (emissionEl) {
                                    emissionEl.textContent = `${actualEmission.toLocaleString()} å™¸`;
                                }
                                
                                // æ›´æ–°æ’æ”¾æ¢ï¼ˆç›¸å°æ¯”ä¾‹ï¼‰
                                const width = Math.max(10, (actualEmission / maxE) * 100);
                                bar.style.width = `${Math.min(width, 100)}%`;

                                // æ›´æ–°æ’æ”¾æ¨™ç±¤
                                if (actualEmission > 20000) {
                                    label.innerText = 'æ’æ”¾çˆ†è¡¨ï¼';
                                } else if (actualEmission > 10000) {
                                    label.innerText = 'æ’æ”¾åé«˜';
                                } else {
                                    label.innerText = key === 'B' ? 'ç§‘æŠ€æ¸›ç¢³ä¸­...' :
                                        key === 'A' ? 'é«˜æ’æ”¾å±éšªç¾¤' : 'ç²¾æ‰“ç´°ç®—å‹';
                                }
                            });
                        }

                        // --- Modal & Action Logic ---

                        function openBuildModal(index) {
                            // åªæœ‰ç©å®¶æ¬„ä½èƒ½é–‹
                            const grid = document.getElementById('game-grid');
                            // ä½¿ç”¨ dataset.index æŸ¥æ‰¾åœ°å¡Šï¼Œè€Œä¸æ˜¯ä¾è³´ children é †åº
                            const tile = Array.from(grid.children).find(t => t.dataset.index == index);
                            if (!tile || tile.dataset.owner !== 'P') {
                                // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                                if (window.DEBUG_MODE) {
                                    console.warn('ç„¡æ³•æ‰“é–‹å»ºé€ æ¨¡æ…‹æ¡†ï¼šåœ°å¡Šä¸å­˜åœ¨æˆ–ä¸æ˜¯ç©å®¶æ‰€æœ‰', { index, tile, owner: tile?.dataset.owner });
                                }
                                return;
                            }

                            // å·²æœ‰å»ºç¯‰å°±ä¸é–‹
                            if (gameState.buildings.find(b => b.tileIndex === index)) {
                                // é–‹ç™¼æ¨¡å¼æ‰é¡¯ç¤ºè©³ç´°æ—¥èªŒ
                                if (window.DEBUG_MODE) {
                                    console.log('åœ°å¡Šå·²æœ‰å»ºç¯‰ï¼Œç„¡æ³•å»ºé€ ', { index });
                                }
                                return;
                            }
                            selectedTileIndex = index;

                            const container = document.getElementById('build-options');
                            container.innerHTML = '';

                            Object.values(BUILDINGS).forEach(b => {
                                const div = document.createElement('div');
                                div.className = 'bg-slate-700 hover:bg-slate-600 border border-slate-600 p-3 rounded-xl cursor-pointer transition relative group';
                                div.onclick = () => selectBuildingPreview(b);
                                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-3xl">${b.emoji}</span>
                        <span class="font-mono font-bold text-yellow-400">$${b.cost}</span>
                    </div>
                    <div class="font-bold text-white mt-1">${b.name}</div>
                    <div class="text-[10px] text-slate-400 mt-1">${b.desc}</div>
                `;
                                container.appendChild(div);
                            });

                            document.getElementById('build-modal').classList.remove('hidden');

                            // Reset Preview
                            document.getElementById('risk-icon').innerText = 'â”';
                            document.getElementById('risk-text').innerText = 'è«‹é¸æ“‡å·¥å» ...';
                            document.getElementById('risk-profit').innerText = '';
                        }

                        function selectBuildingPreview(building) {
                            // ä½¿ç”¨ CarbonFeeSystem è¨ˆç®—é ä¼°æ’æ”¾
                            const currentEmission = carbonFeeSystem.calculateTotalEmission('P');

                            // æ¨¡æ“¬æ·»åŠ å»ºç¯‰å¾Œçš„æ’æ”¾ï¼ˆç°¡åŒ–ï¼šç›´æ¥åŠ åŸºç¤æ’æ”¾ï¼‰
                            // å¯¦éš›æ‡‰è©²è€ƒæ…®åœŸåœ°å±¬æ€§å’Œç­‰ç´šï¼Œä½†é è¦½æ™‚ç°¡åŒ–è™•ç†
                            const land = landSystem.getLand(selectedTileIndex);
                            const landCoeff = land ? land.emissionCoeff : 1.0;
                            const projectedEmission = currentEmission + (building.emission * landCoeff);

                            let riskHTML = '';
                            let icon = '';
                            let profit = building.income;

                            if (gameState.money < building.cost) {
                                icon = 'ğŸ’¸';
                                riskHTML = `<span class="text-rose-400">éŒ¢ä¸å¤ ï¼ä½ éœ€è¦ $${building.cost}</span>`;
                            } else if (projectedEmission > 25000) {
                                icon = 'ğŸ¤¬';
                                riskHTML = `<span class="text-rose-400">å±éšªï¼é€™æœƒæ¿€æ€’æ€ªç¸ï¼(ç´…å€)</span>`;
                            } else if (projectedEmission > GAME_CONFIG.freeEmission) {
                                icon = 'ğŸ¤”';
                                riskHTML = `<span class="text-yellow-400">æ³¨æ„ï¼Œé€™æœƒå¢åŠ ç¢³è²»æˆæœ¬ã€‚</span>`;
                            } else {
                                icon = 'ğŸ‘';
                                riskHTML = `<span class="text-emerald-400">å¥½é¸æ“‡ï¼ä¿æŒåœ¨å®‰å…¨ç¯„åœå…§ã€‚</span>`;
                            }

                            // é¡¯ç¤ºåœŸåœ°è³‡è¨Š
                            if (land) {
                                riskHTML += `<br><span class="text-xs text-slate-400">åœŸåœ°ï¼š${land.name} (${land.description})</span>`;
                            }

                            document.getElementById('risk-icon').innerText = icon;
                            document.getElementById('risk-text').innerHTML = riskHTML;
                            document.getElementById('risk-profit').innerHTML = `é ä¼°å¹´æ”¶: <span class="text-emerald-400">+$${profit}</span>`;

                            // å¢åŠ ç¢ºèªæŒ‰éˆ•
                            const container = document.getElementById('build-options');
                            const oldBtn = document.getElementById('confirm-build-btn');
                            if (oldBtn) oldBtn.remove();

            // æª¢æŸ¥æ˜¯å¦å¯ä»¥å»ºé€ ï¼ˆåŒ…æ‹¬è³‡é‡‘å’Œå»ºé€ æ¬¡æ•¸é™åˆ¶ï¼‰
            const canAfford = gameState.money >= building.cost;
            const canBuildNow = canPlayerBuild();
            const currentCount = getCurrentBuildCount();
            const maxBuildings = getMaxBuildsPerTurn();

                            if (canAfford && canBuildNow) {
                                const btn = document.createElement('button');
                                btn.id = 'confirm-build-btn';
                                btn.className = 'col-span-2 mt-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg';
                                btn.innerText = `ç¢ºèªå»ºé€  ${building.name}`;
                                btn.onclick = () => confirmBuild(building);
                                container.appendChild(btn);
                            } else if (!canAfford) {
                                const btn = document.createElement('button');
                                btn.id = 'confirm-build-btn';
                                btn.className = 'col-span-2 mt-2 bg-slate-600 text-slate-400 font-bold py-2 rounded-lg cursor-not-allowed';
                                btn.innerText = `è³‡é‡‘ä¸è¶³ (éœ€è¦ $${building.cost.toLocaleString()})`;
                                btn.disabled = true;
                                container.appendChild(btn);
            } else if (!canBuildNow) {
                                const btn = document.createElement('button');
                                btn.id = 'confirm-build-btn';
                                btn.className = 'col-span-2 mt-2 bg-rose-600 text-white font-bold py-2 rounded-lg cursor-not-allowed';
                btn.innerText = `æœ¬å›åˆå»ºé€ æ¬¡æ•¸å·²ç”¨å®Œ (${currentCount}/${maxBuildings})`;
                                btn.disabled = true;
                                container.appendChild(btn);
                            }
                        }

                        function confirmBuild(building) {
            const currentCount = getCurrentBuildCount();
            const maxBuildings = getMaxBuildsPerTurn();

            if (currentCount >= maxBuildings || !canPlayerBuild()) {
                showToast(`âŒ æœ¬å›åˆå·²å»ºé€  ${currentCount} å€‹å»ºç¯‰ï¼Œæœ€å¤šåªèƒ½å»ºé€  ${maxBuildings} å€‹ï¼`);
                closeModal('build-modal');
                return;
            }

                            // æª¢æŸ¥è³‡é‡‘
                            if (gameState.money < building.cost) {
                                showToast(`è³‡é‡‘ä¸è¶³ï¼éœ€è¦ $${building.cost.toLocaleString()}`);
                                return;
                            }

                            // æ—©æœŸæ“´å¼µè­¦å‘Šï¼ˆå‰3å›åˆï¼‰
                            if (gameState.turn <= 3 && GAME_CONFIG.earlyExpansionPenalty) {
                                const warning = `âš ï¸ æ—©æœŸæ“´å¼µè­¦å‘Šï¼šå‰3å›åˆå»ºé€ çš„å»ºç¯‰ï¼Œç¢³è²»å°‡å¢åŠ  ${(GAME_CONFIG.earlyExpansionPenaltyRate * 100 - 100).toFixed(0)}%ï¼`;
                                if (!confirm(warning + '\n\nç¢ºå®šè¦ç¹¼çºŒå»ºé€ å—ï¼Ÿ')) {
                                    return;
                                }
                            }

            // å…ˆå¢åŠ å»ºé€ è¨ˆæ•¸ï¼ˆåœ¨å¯¦éš›å»ºé€ å‰ï¼Œé˜²æ­¢é‡è¤‡å»ºé€ ï¼‰
            const countBeforeIncrement = getCurrentBuildCount();
            incrementPlayerBuildCount();

            // é©—è­‰è¨ˆæ•¸æ²’æœ‰è¶…éé™åˆ¶
            if (getCurrentBuildCount() > maxBuildings) {
                // å¦‚æœè¶…éé™åˆ¶ï¼Œå›é€€è¨ˆæ•¸ä¸¦é˜»æ­¢å»ºé€ 
                gameState.buildingsBuiltThisTurn = countBeforeIncrement;
                showToast(`âŒ å»ºé€ æ¬¡æ•¸å·²ç”¨å®Œï¼`);
                closeModal('build-modal');
                return;
            }

                            // æ‰£é™¤è³‡é‡‘
                            gameState.subtractMoney(building.cost);

                            // å¯¦éš›å»ºé€ 
                            addBuildingToTile(selectedTileIndex, building.id, 'P', 'Lv1');
                            closeModal('build-modal');

                            // é‡æ–°è¨ˆç®—çµ±è¨ˆæ•¸æ“šï¼ˆæ’æ”¾ã€æ”¶å…¥ç­‰ï¼‰
                            recalcStats();

                            // å¢åŠ ä¸€é»æ€’æ°£ (å»ºé€ æ“¾å‹•)
                            gameState.addMonsterAnger(2);

                            // é¡¯ç¤ºå‰©é¤˜å»ºé€ æ¬¡æ•¸
            const remaining = maxBuildings - getCurrentBuildCount();
                            if (remaining > 0) {
                                showToast(`âœ… å»ºé€ æˆåŠŸï¼æœ¬å›åˆé‚„å¯å»ºé€  ${remaining} å€‹å»ºç¯‰`);
                            } else {
                                showToast(`âœ… å»ºé€ æˆåŠŸï¼æœ¬å›åˆå»ºé€ æ¬¡æ•¸å·²ç”¨å®Œ`);
                            }

                            // æ›´æ–° UI
                            updateUI();
                            
                            // æª¢æŸ¥æˆå°±
                            checkAchievements();
                            
                            // æª¢æŸ¥æ•™å­¸é€²åº¦
                            tutorialSystem.checkAction('wait_build');
                            
                            // è‡ªå‹•ä¿å­˜
                            saveSystem.autoSave(gameState, { lands: landSystem.getAllLands() });
                        }

                        function openShop(type) {
                            const modal = document.getElementById('shop-modal');
                            const title = document.getElementById('shop-title');
                            const priceDisplay = document.getElementById('shop-price');
                            const actions = document.getElementById('shop-actions');

                            modal.classList.remove('hidden');

                            if (type === 'domestic') {
                                title.innerHTML = 'ğŸ›’ åœ‹å…§è¨±å¯è­‰äº¤æ˜“æ‰€';
                                priceDisplay.innerHTML = `$ ${gameState.domesticPrice} <span class="text-xs text-slate-400">/ å™¸</span>`;
                                const p = gameState.domesticPrice;
                                actions.innerHTML = `
                    <button onclick="trade('domestic', 'buy', 100)" class="bg-emerald-700 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è²·é€² 100 å™¸</span>
                        <span class="text-xs opacity-70">èŠ±è²» $${p * 100}</span>
                    </button>
                    <button onclick="trade('domestic', 'buy', 500)" class="bg-emerald-700 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è²·é€² 500 å™¸</span>
                        <span class="text-xs opacity-70">èŠ±è²» $${p * 500}</span>
                    </button>
                    <button onclick="trade('domestic', 'sell', 100)" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è³£å‡º 100 å™¸</span>
                        <span class="text-xs opacity-70">ç²å¾— $${p * 100}</span>
                    </button>
                    <button onclick="trade('domestic', 'sell', 500)" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è³£å‡º 500 å™¸</span>
                        <span class="text-xs opacity-70">ç²å¾— $${p * 500}</span>
                    </button>
                `;
                            } else {
                                title.innerHTML = 'âœˆï¸ åœ‹éš›ç¢³æ¬Šå¸‚å ´ (åªèƒ½è²·)';
                                priceDisplay.innerHTML = `$ ${gameState.intlPrice} <span class="text-xs text-slate-400">/ å™¸</span>`;
                                const p = gameState.intlPrice;
                                actions.innerHTML = `
                    <button onclick="trade('intl', 'buy', 100)" class="bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è³¼è²· 100 å™¸ (é«˜å“è³ª)</span>
                        <span class="text-xs opacity-70">èŠ±è²» $${p * 100}</span>
                    </button>
                    <button onclick="trade('intl', 'buy', 500)" class="bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-xl font-bold flex flex-col items-center">
                        <span>è³¼è²· 500 å™¸ (é«˜å“è³ª)</span>
                        <span class="text-xs opacity-70">èŠ±è²» $${p * 500}</span>
                    </button>
                `;
                            }
                        }

                        function trade(market, action, amount) {
                            const price = market === 'domestic' ? gameState.domesticPrice : gameState.intlPrice;
                            const cost = amount * price;

                            if (action === 'buy') {
                                if (gameState.money >= cost) {
                                    gameState.subtractMoney(cost);
                                    if (market === 'domestic') {
                                        gameState.setDomesticCredits(gameState.domesticCredits + amount);
                                    } else {
                                        gameState.setIntlCredits(gameState.intlCredits + amount);
                                    }
                                    showToast(`äº¤æ˜“æˆåŠŸï¼è²·é€² ${amount} å™¸`);
                                } else {
                                    showToast("è³‡é‡‘ä¸è¶³ï¼");
                                    return; // Don't close modal
                                }
                            } else {
                                if (gameState.domesticCredits >= amount) {
                                    gameState.addMoney(cost);
                                    gameState.setDomesticCredits(gameState.domesticCredits - amount);
                                    showToast(`æˆåŠŸè³£å‡º ${amount} å™¸`);
                                } else {
                                    showToast("åº«å­˜ä¸è¶³ï¼");
                                    return;
                                }
                            }
                            closeModal('shop-modal');
                        }

                        // NPC è¡Œå‹•ç¾åœ¨ç”± NPCAISystem è™•ç†ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

                        function computeRankAndPollutionInfo() {
                            // ä½¿ç”¨ CarbonFeeSystem è¨ˆç®—å¯¦éš›æ’æ”¾
                            const playerEmission = carbonFeeSystem.calculateTotalEmission('P');
                            const list = [
                                { key: 'Player', name: 'ä½ ', money: gameState.money, emission: playerEmission },
                                ...Object.entries(gameState.competitors).map(([k, v]) => ({
                                    key: k,
                                    name: v.name,
                                    money: v.money,
                                    emission: carbonFeeSystem.calculateTotalEmission(k)
                                }))
                            ];

                            list.sort((a, b) => b.money - a.money);
                            const playerIndex = list.findIndex(x => x.key === 'Player');

                            // æ‰¾å‡ºæ±¡æŸ“ç‹
                            const pollutionKing = [...list].sort((a, b) => b.emission - a.emission)[0];

                            return { rankList: list, playerRank: playerIndex + 1, pollutionKing };
                        }

                        // --- Turn Logic ---

        function endTurn() {
            if (isSettlementPending) {
                showToast('è«‹å…ˆé»æ“Šã€Œç¹¼çºŒä¸‹ä¸€å›åˆã€å®Œæˆçµç®—ï¼');
                return;
            }

            isSettlementPending = true;
            setEndTurnButtonDisabled(true);

            try {
                // ä½¿ç”¨ TurnSystem åŸ·è¡Œå¹´åº¦çµç®—
                const settlement = turnSystem.executeYearEndSettlement();

                const income = settlement.income;
                const displayTax = settlement.carbonFee;
                const cbamTax = settlement.cbamTax;

                // NPC è¡Œå‹• - ä½¿ç”¨ NPCAISystem
                const npcEvents = npcAISystem.executeAllNPCs();

                // ç«‹å³æ›´æ–° NPC UIï¼ˆé¡¯ç¤ºæœ€æ–°çš„è³‡é‡‘å’Œç¢³æ’æ”¾ï¼‰
                updateNPCUI();

                // æ›´æ–° NPC å»ºç¯‰çš„è¦–è¦ºï¼ˆå› ç‚º NPCAISystem åªæ›´æ–°ç‹€æ…‹ï¼Œéœ€è¦åŒæ­¥è¦–è¦ºï¼‰
                gameState.buildings
                    .filter(b => b.owner !== 'P')
                    .forEach(building => {
                        const tile = document.querySelector(`#game-grid > div[data-index="${building.tileIndex}"]`);
                        if (tile) {
                            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°è¦–è¦ºï¼ˆå¦‚æœåœ°å¡Šæ²’æœ‰å»ºç¯‰åœ–æ¨™ï¼‰
                            const hasBuildingIcon = tile.querySelector('.text-3xl');
                            if (!hasBuildingIcon) {
                                addBuildingToTile(building.tileIndex, building.type, building.owner, building.level || 'Lv1');
                            } else {
                                // æ›´æ–°ç­‰ç´šæ¨™ç±¤
                                const levelBadge = tile.querySelector('.absolute.top-1.right-1');
                                const level = building.level || 'Lv1';
                                if (level !== 'Lv1') {
                                    if (!levelBadge) {
                                        const badge = document.createElement('div');
                                        badge.className = 'absolute top-1 right-1 text-[8px] bg-blue-600 text-white px-1 rounded';
                                        badge.textContent = level;
                                        tile.appendChild(badge);
                                    } else {
                                        levelBadge.textContent = level;
                                    }
                                }
                            }
                        }
                    });

                // æ›´æ–° NPC è³¼è²·åœ°å¡Šå¾Œçš„è¦–è¦ºï¼ˆæª¢æŸ¥æ‰€æœ‰åœ°å¡Šçš„æ‰€æœ‰è€…è®ŠåŒ–ï¼‰
                landSystem.getAllLands().forEach(land => {
                    const tile = document.querySelector(`#game-grid > div[data-index="${land.index}"]`);
                    if (tile) {
                        const building = gameState.getBuildingAtTile(land.index);
                        // å¦‚æœåœ°å¡Šæ²’æœ‰å»ºç¯‰ï¼Œæ›´æ–°è¦–è¦ºä»¥åæ˜ æ–°çš„æ‰€æœ‰è€…
                        if (!building) {
                            updateTileVisual(land.index);
                            }
                        }
                    });

                // æ›´æ–°æ€ªç¸
                const monsterUpdate = turnSystem.updateMonsterFromGlobalEmission();

                // æ›´æ–°å¸‚å ´åƒ¹æ ¼
                const priceUpdate = turnSystem.updateMarketPrices();

                // æ’åè¨ˆç®—
                const { rankList, playerRank, pollutionKing } = computeRankAndPollutionInfo();

                // æ›´æ–°å ±å‘Š Modal
                document.getElementById('report-income').innerText = `+ $${income}`;
                const totalTax = displayTax + cbamTax;
                document.getElementById('report-tax').innerText = `- $${totalTax} (ç¢³è²»: $${displayTax}${cbamTax > 0 ? ` + CBAM: $${cbamTax}` : ''})`;
                document.getElementById('report-year-label').innerText = `${gameState.year} å¹´çµç®—å ±å‘Š`;
                document.getElementById('report-rank').innerText = `ç¬¬ ${playerRank} å`;

                const first = rankList[0];
                const carbonFeeResult = carbonFeeSystem.calculateCarbonFee('P');
                let detailHTML = `
                <p>ğŸ‘‘ ç¬¬ä¸€åï¼š${first.name} ($${first.money})</p>
                <p>â˜ ï¸ æ±¡æŸ“ç‹ï¼š${pollutionKing.name} (æ’æ”¾ ${pollutionKing.emission} å™¸)</p>
            `;

                // æ·»åŠ æŸ¥æ ¸äº‹ä»¶è³‡è¨Š
                if (settlement.auditEvent) {
                    detailHTML += `<p class="text-xs mt-2 text-yellow-600 font-bold">${settlement.auditEvent.message}</p>`;
                }

                // æ·»åŠ  CBAM è³‡è¨Š
                if (settlement.cbamApplied && cbamTax > 0) {
                    detailHTML += `<p class="text-xs mt-1 text-blue-600">âš ï¸ CBAM å¢ƒå¤–ç¨…å·²ç”Ÿæ•ˆï¼ˆç¬¬ ${GAME_CONFIG.cbamStartTurn} å›åˆèµ·ï¼‰</p>`;
                }

                document.getElementById('report-rank-detail').innerHTML = detailHTML;

                document.getElementById('report-modal').classList.remove('hidden');

                // æ›´æ–° NPC æ’åå°æ¨™
                rankList.forEach((item, index) => {
                    if (item.key === 'A') document.getElementById('npcA-rank').innerText = `#${index + 1}`;
                    if (item.key === 'B') document.getElementById('npcB-rank').innerText = `#${index + 1}`;
                    if (item.key === 'C') document.getElementById('npcC-rank').innerText = `#${index + 1}`;
                });

                // æ–°èï¼šæŠŠé€™å›åˆç™¼ç”Ÿçš„äº‹æƒ…è½‰æˆè¨Šæ¯
                const newsEvents = [];

                newsEvents.push(`ä½ æœ¬å¹´æ·¨è³º $${income}ï¼Œæ”¯ä»˜ç¢³è²» $${displayTax}${cbamTax > 0 ? `ï¼ŒCBAM ç¨… $${cbamTax}` : ''}ã€‚`);

                // æŸ¥æ ¸äº‹ä»¶
                if (settlement.auditEvent) {
                    newsEvents.push(settlement.auditEvent.message);
                }

                if (npcEvents && npcEvents.length > 0) {
                    newsEvents.push(...npcEvents);
                }

                // å¸‚å ´åƒ¹æ ¼è®Šå‹•
                if (priceUpdate.domesticPrice.change !== 0) {
                    const diff = priceUpdate.domesticPrice.change;
                    const dir = diff > 0 ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ';
                    newsEvents.push(`åœ‹å…§ç¢³è²»${dir}è‡³ $${priceUpdate.domesticPrice.new} / å™¸ã€‚`);
                }

                newsEvents.push(`å…¨çƒæ’æ”¾ ${monsterUpdate.totalWorldEmission.toLocaleString()} å™¸ï¼Œæ€ªç¸æ€’æ°£ +${monsterUpdate.growth}% (ç›®å‰ç´„ ${gameState.monsterAnger}%)ã€‚`);

                updateNews(newsEvents);

                updateUI();
                updateMonsterVisuals();
                
                // æª¢æŸ¥æˆå°±
                checkAchievements();
                
                // æª¢æŸ¥æ•™å­¸é€²åº¦
                tutorialSystem.checkAction('wait_end_turn');
                
                // è‡ªå‹•ä¿å­˜
                saveSystem.autoSave(gameState, { lands: landSystem.getAllLands() });
            } catch (error) {
                // éŒ¯èª¤è™•ç†ï¼šç”Ÿç”¢ç’°å¢ƒé¡¯ç¤ºå‹å–„è¨Šæ¯ï¼Œé–‹ç™¼æ¨¡å¼é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                if (window.DEBUG_MODE) {
                    console.error('âŒ endTurn ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                    showToast('çµç®—éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Console è¨Šæ¯');
                } else {
                    console.error('éŠæˆ²éŒ¯èª¤ï¼š', error.message || 'æœªçŸ¥éŒ¯èª¤');
                    showToast('çµç®—éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
                isSettlementPending = false;
                setEndTurnButtonDisabled(false);
            }
                        }

                        function startNextTurn() {
                            gameState.nextTurn();
                            closeModal('report-modal');
            isSettlementPending = false;
            setEndTurnButtonDisabled(false);

                            // æª¢æŸ¥éŠæˆ²çµæŸ
                            if (gameState.monsterAnger >= 100) {
                                showGameOverModal('monster');
                                return;
                            } else if (gameState.turn > GAME_CONFIG.maxYears) {
                                showGameOverModal('normal');
                                return;
                            }
                        }

                        function updateNews(events) {
                            if (!events || events.length === 0) return;
                            const feed = document.getElementById('news-feed');
                            const newHtml = events.map(e =>
                                `<p class="border-l-2 border-yellow-500 pl-2 text-yellow-200">${e}</p>`
                            ).join('') + feed.innerHTML;
                            feed.innerHTML = newHtml;
                        }

                        // --- Helper Functions ---

                        function closeModal(id) {
                            document.getElementById(id).classList.add('hidden');
                        }

                        // --- é ­åƒæ›´æ›åŠŸèƒ½ ---
                        function getAvatarSeed() {
                            // å¾ localStorage è®€å–ä¿å­˜çš„é ­åƒç¨®å­
                            return localStorage.getItem('playerAvatarSeed') || 'Player1';
                        }

                        function saveAvatarSeed(seed) {
                            // ä¿å­˜é ­åƒç¨®å­åˆ° localStorage
                            localStorage.setItem('playerAvatarSeed', seed);
                        }

                        function updateAvatarImage(seed) {
                            // æ›´æ–°é ­åƒåœ–ç‰‡
                            const img = document.getElementById('player-avatar-img');
                            if (img) {
                                img.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed)}&backgroundColor=b6e3f4`;
                            }
                        }

                        function openAvatarModal() {
                            const modal = document.getElementById('avatar-modal');
                            const optionsContainer = document.getElementById('avatar-options');
                            
                            // ç”Ÿæˆé è¨­é ­åƒé¸é …
                            const presetSeeds = [
                                'Player1', 'Business', 'CEO', 'Manager', 
                                'Leader', 'Boss', 'Executive', 'Director',
                                'Entrepreneur', 'Innovator', 'Visionary', 'Strategist'
                            ];
                            
                            optionsContainer.innerHTML = '';
                            presetSeeds.forEach(seed => {
                                const div = document.createElement('div');
                                div.className = 'cursor-pointer group';
                                div.onclick = () => selectAvatar(seed);
                                div.innerHTML = `
                                    <div class="w-16 h-16 mx-auto bg-indigo-500 rounded-full border-2 border-slate-600 overflow-hidden group-hover:border-blue-400 transition">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed)}&backgroundColor=b6e3f4"
                                            alt="${seed}" class="w-full h-full object-cover">
                                    </div>
                                    <p class="text-xs text-slate-400 text-center mt-1 group-hover:text-white transition">${seed}</p>
                                `;
                                optionsContainer.appendChild(div);
                            });
                            
                            modal.classList.remove('hidden');
                        }

                        function selectAvatar(seed) {
                            updateAvatarImage(seed);
                            saveAvatarSeed(seed);
                            closeModal('avatar-modal');
                            showToast('âœ… é ­åƒå·²æ›´æ›ï¼');
                        }

                        function applyCustomAvatar() {
                            const input = document.getElementById('custom-avatar-seed');
                            const seed = input.value.trim();
                            if (seed) {
                                selectAvatar(seed);
                                input.value = '';
                            } else {
                                showToast('âŒ è«‹è¼¸å…¥åç¨±');
                            }
                        }

                        // åˆå§‹åŒ–æ™‚è¼‰å…¥ä¿å­˜çš„é ­åƒ
                        function initAvatar() {
                            const seed = getAvatarSeed();
                            updateAvatarImage(seed);
                        }

                        function speak(text) {
                            const el = document.getElementById('robot-msg');
                            el.innerHTML = text;
                            el.parentElement.classList.add('animate-shake');
                            setTimeout(() => el.parentElement.classList.remove('animate-shake'), 500);
                        }

                        function showToast(msg) {
                            const toast = document.createElement('div');
                            toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-600 z-[100] animate-float';
                            toast.innerText = msg;
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 2000);
                        }

                        function animateValue(id, end, prefix) {
                            const obj = document.getElementById(id);
                            obj.innerText = prefix + end.toLocaleString();
                        }

                        // å‰µå»ºå»ºç¯‰ç®¡ç†æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                        function createBuildingManagementModal() {
                            // æ¨¡æ…‹æ¡†å·²åœ¨ HTML ä¸­å®šç¾©ï¼Œæ­¤å‡½æ•¸ä¿ç•™ä»¥å‚™å°‡ä¾†æ“´å±•
                        }

                        // --- ä¿å­˜/è¼‰å…¥ç³»çµ±å‡½æ•¸ ---
                        function openSaveLoadModal() {
                            const modal = document.getElementById('save-load-modal');
                            modal.classList.remove('hidden');
                            updateSaveSlots();
                        }

                        function updateSaveSlots() {
                            const slotsContainer = document.getElementById('save-slots');
                            const saveInfo = saveSystem.getSaveInfo();
                            
                            slotsContainer.innerHTML = '';
                            saveInfo.forEach((info, index) => {
                                const slotDiv = document.createElement('div');
                                slotDiv.className = 'bg-slate-700 p-3 rounded-lg border border-slate-600 flex items-center justify-between';
                                
                                if (info.exists) {
                                    slotDiv.innerHTML = `
                                        <div class="flex-1">
                                            <div class="font-bold text-white">æ§½ä½ ${index + 1}</div>
                                            <div class="text-xs text-slate-400">ç¬¬ ${info.turn} å›åˆ | ${info.year} å¹´</div>
                                            <div class="text-xs text-slate-500">$${info.money.toLocaleString()} | ${info.formattedDate}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="loadGame(${index})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded">è¼‰å…¥</button>
                                            <button onclick="saveGame(${index})" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-sm rounded">ä¿å­˜</button>
                                            <button onclick="deleteSave(${index})" class="px-3 py-1 bg-rose-600 hover:bg-rose-500 text-white text-sm rounded">åˆªé™¤</button>
                                        </div>
                                    `;
                                } else {
                                    slotDiv.innerHTML = `
                                        <div class="flex-1 text-slate-400">æ§½ä½ ${index + 1} (ç©º)</div>
                                        <button onclick="saveGame(${index})" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded">ä¿å­˜</button>
                                    `;
                                }
                                
                                slotsContainer.appendChild(slotDiv);
                            });
                        }

                        function saveGame(slotIndex) {
                            const additionalData = {
                                lands: landSystem.getAllLands()
                            };
                            if (saveSystem.saveGame(slotIndex, gameState, additionalData)) {
                                showToast(`âœ… éŠæˆ²å·²ä¿å­˜åˆ°æ§½ä½ ${slotIndex + 1}`);
                                updateSaveSlots();
                            } else {
                                showToast('âŒ ä¿å­˜å¤±æ•—');
                            }
                        }

                        function loadGame(slotIndex) {
                            const saveData = saveSystem.loadGame(slotIndex, gameState);
                            if (saveData) {
                                // æ¢å¾©åœŸåœ°ç³»çµ±
                                if (saveData.additionalData && saveData.additionalData.lands) {
                                    // é‡æ–°åˆå§‹åŒ–åœŸåœ°ç³»çµ±ï¼ˆç°¡åŒ–è™•ç†ï¼‰
                                    landSystem.initializeLands(20, ['P', 'A', 'B', 'C']);
                                }
                                
                                // é‡æ–°åˆå§‹åŒ– NPC AI
                                npcAISystem = new NPCAISystem(gameState, carbonFeeSystem, landSystem);
                                
                                // æ›´æ–° UI
                                initGrid();
                                updateUI();
                                updateMonsterVisuals();
                                
                                showToast(`âœ… éŠæˆ²å·²å¾æ§½ä½ ${slotIndex + 1} è¼‰å…¥`);
                                closeModal('save-load-modal');
                            } else {
                                showToast('âŒ è¼‰å…¥å¤±æ•—');
                            }
                        }

                        function deleteSave(slotIndex) {
                            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ§½ä½ ${slotIndex + 1} çš„å­˜æª”å—ï¼Ÿ`)) {
                                if (saveSystem.deleteSave(slotIndex)) {
                                    showToast(`âœ… æ§½ä½ ${slotIndex + 1} çš„å­˜æª”å·²åˆªé™¤`);
                                    updateSaveSlots();
                                }
                            }
                        }

                        function autoSaveGame() {
                            saveGame(0);
                        }

                        // --- æˆå°±ç³»çµ±å‡½æ•¸ ---
                        function openAchievementModal() {
                            const modal = document.getElementById('achievement-modal');
                            modal.classList.remove('hidden');
                            updateAchievementUI();
                        }

                        function updateAchievementUI() {
                            const progress = achievementSystem.getProgress();
                            const progressEl = document.getElementById('achievement-progress');
                            progressEl.innerHTML = `
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-bold text-slate-300">æˆå°±é€²åº¦</span>
                                    <span class="text-sm font-bold text-white">${progress.unlocked} / ${progress.total}</span>
                                </div>
                                <div class="w-full bg-slate-800 rounded-full h-2 mb-2">
                                    <div class="bg-emerald-500 h-2 rounded-full transition-all" style="width: ${progress.progress}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span>æˆå°±é»æ•¸: ${progress.unlockedPoints} / ${progress.totalPoints}</span>
                                    <span>${progress.progress}%</span>
                                </div>
                            `;

                            const listEl = document.getElementById('achievement-list');
                            const allAchievements = achievementSystem.getAllAchievements();
                            
                            listEl.innerHTML = '';
                            allAchievements.forEach(achievement => {
                                const isUnlocked = achievementSystem.unlockedAchievements.includes(achievement.id);
                                const div = document.createElement('div');
                                div.className = `bg-slate-700 p-3 rounded-lg border ${isUnlocked ? 'border-emerald-500' : 'border-slate-600 opacity-60'}`;
                                div.innerHTML = `
                                    <div class="flex items-start gap-3">
                                        <div class="text-3xl">${achievement.icon}</div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold ${isUnlocked ? 'text-white' : 'text-slate-400'}">${achievement.name}</span>
                                                ${isUnlocked ? '<span class="text-xs bg-emerald-500 text-white px-2 py-0.5 rounded">å·²è§£é–</span>' : ''}
                                            </div>
                                            <div class="text-sm ${isUnlocked ? 'text-slate-300' : 'text-slate-500'}">${achievement.description}</div>
                                            <div class="text-xs text-slate-500 mt-1">${achievement.points} é» | ${achievement.category === 'hidden' ? 'éš±è—æˆå°±' : achievement.category}</div>
                                        </div>
                                    </div>
                                `;
                                listEl.appendChild(div);
                            });
                        }

                        function checkAchievements() {
                            const rankInfo = computeRankAndPollutionInfo();
                            const newlyUnlocked = achievementSystem.checkAchievements(
                                gameState,
                                carbonFeeSystem,
                                { BUILDINGS, rankInfo, landSystem }
                            );

                            if (newlyUnlocked.length > 0) {
                                newlyUnlocked.forEach(achievement => {
                                    showToast(`ğŸ† æˆå°±è§£é–: ${achievement.name}`, 3000);
                                });
                                updateAchievementBadge();
                            }
                        }

                        function updateAchievementBadge() {
                            const badge = document.getElementById('achievement-badge');
                            const progress = achievementSystem.getProgress();
                            if (progress.unlocked > 0) {
                                badge.textContent = progress.unlocked;
                                badge.classList.remove('hidden');
                            }
                        }

                        // --- åœ°å¡Šè³¼è²·å‡½æ•¸ ---
                        function openLandPurchaseModal(tileIndex) {
                            const modal = document.getElementById('land-purchase-modal');
                            const contentEl = document.getElementById('land-purchase-content');
                            
                            const land = landSystem.getLand(tileIndex);
                            if (!land) {
                                showToast('åœ°å¡Šä¸å­˜åœ¨ï¼');
                                return;
                            }

                            // æª¢æŸ¥æ˜¯å¦å¯ä»¥è³¼è²·
                            if (!gameState.canPurchaseLand()) {
                                showToast('æœ¬å›åˆå·²è³¼è²·éåœ°å¡Šï¼Œæ¯å›åˆæœ€å¤šè³¼è²· 1 å€‹ï¼');
                                return;
                            }

                            // è¨ˆç®—è³¼è²·åƒ¹æ ¼
                            const price = landSystem.calculatePurchasePrice(tileIndex, gameState.turn, gameState.money);
                            const canAfford = gameState.money >= price;
                            const landTypeInfo = landSystem.getLandTypeInfo(land.type);
                            const currentOwner = OWNER_CONFIG[land.owner];

                            contentEl.innerHTML = `
                                <div class="space-y-4">
                                    <!-- åœ°å¡Šä¿¡æ¯ -->
                                    <div class="bg-slate-900 p-4 rounded-lg">
                                        <div class="flex items-center gap-3 mb-3">
                                            <span class="text-4xl">${land.emoji}</span>
                                            <div>
                                                <div class="font-bold text-white text-lg">${land.name}</div>
                                                <div class="text-sm text-slate-400">${landTypeInfo.description}</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div>
                                                <div class="text-slate-400">ç•¶å‰æ‰€æœ‰è€…</div>
                                                <div class="font-bold text-white">${currentOwner.name}</div>
                                            </div>
                                            <div>
                                                <div class="text-slate-400">æ’æ”¾ä¿‚æ•¸</div>
                                                <div class="font-bold ${land.emissionCoeff < 1 ? 'text-emerald-400' : land.emissionCoeff > 1 ? 'text-rose-400' : 'text-white'}">
                                                    ${land.emissionCoeff.toFixed(2)}x
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- åƒ¹æ ¼ä¿¡æ¯ -->
                                    <div class="bg-slate-900 p-4 rounded-lg border-2 ${canAfford ? 'border-emerald-500' : 'border-rose-500'}">
                                        <div class="text-xs text-slate-400 mb-1">è³¼è²·åƒ¹æ ¼</div>
                                        <div class="text-3xl font-black ${canAfford ? 'text-emerald-400' : 'text-rose-400'}">
                                            $${price.toLocaleString()}
                                        </div>
                                        <div class="text-xs text-slate-500 mt-1">
                                            ç•¶å‰è³‡é‡‘: $${gameState.money.toLocaleString()}
                                        </div>
                                        ${!canAfford ? '<div class="text-xs text-rose-400 mt-2">âš ï¸ è³‡é‡‘ä¸è¶³ï¼</div>' : ''}
                                    </div>

                                    <!-- è³¼è²·èªªæ˜ -->
                                    <div class="bg-blue-900/30 p-3 rounded-lg border border-blue-500">
                                        <div class="text-xs text-blue-200">
                                            ğŸ’¡ è³¼è²·å¾Œï¼Œæ­¤åœ°å¡Šå°‡æ­¸æ‚¨æ‰€æœ‰ï¼Œå¯ä»¥ç«‹å³å»ºé€ å»ºç¯‰ã€‚æ¯å›åˆæœ€å¤šè³¼è²· 1 å€‹åœ°å¡Šã€‚
                                        </div>
                                    </div>

                                    <!-- è³¼è²·æŒ‰éˆ• -->
                                    <button 
                                        onclick="confirmLandPurchase(${tileIndex}, ${price})" 
                                        ${!canAfford ? 'disabled' : ''}
                                        class="w-full py-3 ${canAfford ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-slate-600 cursor-not-allowed'} text-white font-bold rounded-lg transition">
                                        ${canAfford ? 'ç¢ºèªè³¼è²·' : 'è³‡é‡‘ä¸è¶³'}
                                    </button>
                                </div>
                            `;

                            modal.classList.remove('hidden');
                        }

                        function confirmLandPurchase(tileIndex, price) {
                            // å†æ¬¡æª¢æŸ¥æ¢ä»¶
                            if (!gameState.canPurchaseLand()) {
                                showToast('æœ¬å›åˆå·²è³¼è²·éåœ°å¡Šï¼');
                                return;
                            }

                            if (gameState.money < price) {
                                showToast('è³‡é‡‘ä¸è¶³ï¼');
                                return;
                            }

                            const checkResult = landSystem.canPurchase(tileIndex, 'P', (idx) => {
                                return gameState.getBuildingAtTile(idx) !== undefined;
                            });

                            if (!checkResult.canPurchase) {
                                showToast(checkResult.reason);
                                return;
                            }

                            // åŸ·è¡Œè³¼è²·
                            const result = landSystem.purchaseLand(tileIndex, 'P', price);
                            if (result.success) {
                                // æ‰£é™¤è³‡é‡‘
                                gameState.subtractMoney(price);
                                
                                // å¢åŠ è³¼è²·è¨ˆæ•¸
                                gameState.incrementLandPurchaseCount();
                                
                                // æ›´æ–°åœ°å¡Šè¦–è¦º
                                updateTileVisual(tileIndex);
                                
                                // æ›´æ–° UI
                                updateUI();
                                
                                showToast(`âœ… ${result.message}`);
                                closeModal('land-purchase-modal');
                                
                                // æª¢æŸ¥æˆå°±
                                checkAchievements();
                                
                                // è‡ªå‹•ä¿å­˜
                                saveSystem.autoSave(gameState, { lands: landSystem.getAllLands() });
                            } else {
                                showToast(`âŒ ${result.message}`);
                            }
                        }

                        // --- æ•¸æ“šé¢æ¿å‡½æ•¸ ---
                        function toggleDataPanel() {
                            const modal = document.getElementById('data-panel-modal');
                            if (modal.classList.contains('hidden')) {
                                modal.classList.remove('hidden');
                                updateDataPanel();
                            } else {
                                modal.classList.add('hidden');
                            }
                        }

                        function updateDataPanel() {
                            // æ›´æ–°ç¢³è²»è¨ˆç®—è©³æƒ…
                            const carbonFeeResult = carbonFeeSystem.calculateCarbonFee('P');
                            const breakdownEl = document.getElementById('carbon-fee-breakdown');
                            breakdownEl.innerHTML = dataPanel.generateCarbonFeeBreakdown(carbonFeeResult, gameState);

                            // æ›´æ–°æ’æ”¾ä¾†æºè¿½æº¯
                            const playerBuildings = gameState.getPlayerBuildings();
                            const traceEl = document.getElementById('emission-source-trace');
                            traceEl.innerHTML = dataPanel.generateEmissionSourceTrace(
                                playerBuildings,
                                carbonFeeSystem,
                                landSystem,
                                BUILDINGS
                            );
                        }

                        // --- æŠ½å±œæ§åˆ¶å‡½æ•¸ ---
                        function toggleLeftDrawer() {
                            const drawer = document.getElementById('left-drawer');
                            const overlay = document.getElementById('drawer-overlay');
                            if (drawer.classList.contains('drawer-hidden')) {
                                drawer.classList.remove('drawer-hidden');
                                overlay.classList.add('active');
                            } else {
                                drawer.classList.add('drawer-hidden');
                                overlay.classList.remove('active');
                            }
                            // é—œé–‰å³å´æŠ½å±œ
                            const rightDrawer = document.getElementById('right-drawer');
                            rightDrawer.classList.add('drawer-right-hidden');
                        }

                        function toggleRightDrawer() {
                            const drawer = document.getElementById('right-drawer');
                            const overlay = document.getElementById('drawer-overlay');
                            if (drawer.classList.contains('drawer-right-hidden')) {
                                drawer.classList.remove('drawer-right-hidden');
                                overlay.classList.add('active');
                            } else {
                                drawer.classList.add('drawer-right-hidden');
                                overlay.classList.remove('active');
                            }
                            // é—œé–‰å·¦å´æŠ½å±œ
                            const leftDrawer = document.getElementById('left-drawer');
                            leftDrawer.classList.add('drawer-hidden');
                        }

                        function closeAllDrawers() {
                            const leftDrawer = document.getElementById('left-drawer');
                            const rightDrawer = document.getElementById('right-drawer');
                            const overlay = document.getElementById('drawer-overlay');
                            leftDrawer.classList.add('drawer-hidden');
                            rightDrawer.classList.add('drawer-right-hidden');
                            overlay.classList.remove('active');
                        }

                        // --- å°‡å‡½æ•¸é™„åŠ åˆ° window å°è±¡ï¼Œä»¥ä¾¿ HTML çš„ onclick å¯ä»¥è¨ªå• ---
                        window.endTurn = endTurn;
                        window.openShop = openShop;
                        window.closeModal = closeModal;
                        window.startNextTurn = startNextTurn;
                        window.trade = trade;
                        window.openBuildingManagementModal = openBuildingManagementModal;
                        window.closeBuildingManagementModal = closeBuildingManagementModal;
                        window.upgradeBuilding = upgradeBuilding;
                        window.updateTileVisual = updateTileVisual;
                        window.openSaveLoadModal = openSaveLoadModal;
                        window.investInCarbonReduction = investInCarbonReduction;
                        window.saveGame = saveGame;
                        window.loadGame = loadGame;
                        window.deleteSave = deleteSave;
                        window.autoSaveGame = autoSaveGame;
                        window.openAvatarModal = openAvatarModal;
                        window.selectAvatar = selectAvatar;
                        window.applyCustomAvatar = applyCustomAvatar;
                        window.openAchievementModal = openAchievementModal;
                        window.toggleDataPanel = toggleDataPanel;
                        window.closeGameOverModal = closeGameOverModal;
                        window.toggleLeftDrawer = toggleLeftDrawer;
                        window.toggleRightDrawer = toggleRightDrawer;
                        window.closeAllDrawers = closeAllDrawers;
                        window.restartGame = restartGame;
                        window.openLandPurchaseModal = openLandPurchaseModal;
                        window.confirmLandPurchase = confirmLandPurchase;
                        
                        // å°‡æ•™å­¸ç³»çµ±æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿ HTML å¯ä»¥è¨ªå•
                        window.tutorialSystem = tutorialSystem;

                        // --- éŠæˆ²çµæŸå‡½æ•¸ ---
                        function showGameOverModal(reason) {
                            const modal = document.getElementById('game-over-modal');
                            const titleEl = document.getElementById('game-over-title');
                            const contentEl = document.getElementById('game-over-content');
                            
                            if (reason === 'monster') {
                                titleEl.innerHTML = 'ğŸ˜± éŠæˆ²å¤±æ•— - æ€ªç¸æ‘§æ¯€äº†åŸå¸‚ï¼';
                                contentEl.innerHTML = `
                                    <div class="bg-rose-900/30 p-4 rounded-lg border-2 border-rose-500 mb-4">
                                        <p class="text-rose-200 text-center">æ’æ”¾æ€ªç¸çš„æ€’æ°£å€¼é”åˆ° 100%ï¼ŒåŸå¸‚è¢«æ‘§æ¯€äº†ï¼</p>
                                        <p class="text-rose-300 text-center mt-2">æ‰€æœ‰ç©å®¶éƒ½å¤±æ•—äº†...</p>
                                    </div>
                                `;
                            } else {
                                // æ­£å¸¸çµæŸï¼Œè¨ˆç®—å‹åˆ©æ¢ä»¶
                                const victoryResult = victorySystem.calculateVictory(gameState, carbonFeeSystem);
                                titleEl.innerHTML = 'ğŸ† éŠæˆ²çµæŸ';
                                contentEl.innerHTML = victorySystem.generateVictoryReport(victoryResult);
                                
                                // æª¢æŸ¥ä¸¦è§£é–ç›¸é—œæˆå°±
                                const playerResult = victoryResult.victoryResults['P'];
                                if (playerResult && playerResult.victories.length > 0) {
                                    playerResult.victories.forEach(victory => {
                                        // æ ¹æ“šå‹åˆ©æ¢ä»¶è§£é–å°æ‡‰æˆå°±
                                        if (victory.id === 'carbon_pioneer') {
                                            achievementSystem.unlockAchievement('low_emission');
                                        }
                                        if (victory.id === 'efficiency_master') {
                                            achievementSystem.unlockAchievement('efficient_master');
                                        }
                                        if (victory.id === 'perfect_balance') {
                                            achievementSystem.unlockAchievement('perfect_balance');
                                        }
                                    });
                                }
                            }
                            
                            modal.classList.remove('hidden');
                        }

                        function closeGameOverModal() {
                            const modal = document.getElementById('game-over-modal');
                            modal.classList.add('hidden');
                        }

                        function restartGame() {
                            if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦å°‡ä¸Ÿå¤±ã€‚')) {
                                location.reload();
                            }
                        }
                    </script>
</body>

</html>